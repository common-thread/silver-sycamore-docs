---
phase: 10-messaging-channels
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified: [app/src/components/MessageList.tsx, app/src/components/MessageItem.tsx, app/src/components/MessageInput.tsx, app/src/app/messages/[channelId]/page.tsx]
autonomous: true
---

<objective>
Build message thread UI with real-time updates and @mention support.

Purpose: Enable users to send and receive messages in channels with live updates.
Output: Complete messaging experience with real-time message list and input with @mentions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Schema from Plan 01
@.planning/phases/10-messaging-channels/10-01-SUMMARY.md

# Reuse @mention patterns from Phase 8
@app/src/components/MentionInput.tsx
@app/src/components/CommentItem.tsx

# Existing UI components
@app/src/components/ui/Button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MessageList and MessageItem components</name>
  <files>app/src/components/MessageList.tsx, app/src/components/MessageItem.tsx</files>
  <action>
**MessageList.tsx:**
- Props: `channelId: Id<"channels">`
- Use `useQuery(api.messages.listMessages, { channelId, limit: 50 })` for real-time messages
- Reverse chronological display (newest at bottom, chat-style)
- Auto-scroll to bottom on new messages
- Group messages by date with dividers ("Today", "Yesterday", "Jan 15")
- Loading state while fetching
- Empty state: "No messages yet. Start the conversation!"
- Map messages to MessageItem components
- Batch fetch user profiles for authors (like comment mentions pattern)

**MessageItem.tsx:**
- Props: `message`, `author` (user profile), `mentionedUsers` (map)
- Display: avatar (or initial), author name, timestamp, content
- Parse @[userId] mentions and render as styled spans (reuse parseMentions from CommentItem)
- Show "edited" indicator if isEdited=true
- Thread reply indicator: "N replies" if message has children (query count)
- Hover actions (shown on hover):
  - Reply (thread)
  - Edit (if author)
  - Delete (if author or admin)
- Timestamp format: "10:30 AM" for today, "Jan 15, 10:30 AM" for older

**Styling:**
- Compact message layout for chat feel
- Author name in bold, timestamp muted
- Mention spans styled with bronze background
  </action>
  <verify>MessageList renders messages with proper formatting and mentions</verify>
  <done>Message display with real-time updates working</done>
</task>

<task type="auto">
  <name>Task 2: Create MessageInput component with @mentions</name>
  <files>app/src/components/MessageInput.tsx</files>
  <action>
**MessageInput.tsx:**
- Wrapper around MentionInput component (from Phase 8) for message composition
- Props: `channelId: Id<"channels">`, `parentId?: Id<"messages">` (for thread replies)
- Features:
  - Textarea with @mention autocomplete (reuse MentionInput)
  - Send button (or Enter to send, Shift+Enter for newline)
  - Attachment button placeholder (for Plan 05)
  - Disabled state when loading
- On submit:
  - Call `useMutation(api.messages.sendMessage)`
  - Clear input on success
  - Keep focus in input
- Enter key behavior:
  - Enter alone: send message
  - Shift+Enter: newline
  - Prevent send if content is empty/whitespace

**Integration with MentionInput:**
- MentionInput already handles @autocomplete
- Just wrap it with send button and form handling
- Pass through value/onChange for controlled input

**Styling:**
- Input area at bottom of message view
- Send button: primary bronze style
- Placeholder: "Message #channel-name"
  </action>
  <verify>MessageInput sends messages, mentions autocomplete works</verify>
  <done>Message input with @mentions fully functional</done>
</task>

<task type="auto">
  <name>Task 3: Integrate messaging UI into channel page</name>
  <files>app/src/app/messages/[channelId]/page.tsx</files>
  <action>
Update the channel page shell from Plan 02 to use actual messaging components:

**Channel page structure:**
- Header: channel name, description, member count, settings icon
- Main area: MessageList component (flex-grow, scrollable)
- Footer: MessageInput component (fixed at bottom)

**Layout:**
- Flex column layout, full height
- MessageList takes available space with overflow-y-auto
- MessageInput fixed at bottom
- Proper spacing between sections

**Real-time behavior:**
- Messages appear instantly when sent (Convex optimistic updates)
- New messages from others appear automatically (Convex subscriptions)
- Mark channel as read when viewing (call updateLastRead mutation)

**Channel header:**
- Show # + channel name (or lock icon for private)
- Member count: "N members" clickable to show member list
- Settings gear icon (opens channel settings - can be placeholder for now)
  </action>
  <verify>Full messaging flow works: send message, see it appear, see others' messages</verify>
  <done>Complete channel messaging experience working</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Messages display with proper formatting in channel
- [ ] @mentions render as styled links
- [ ] New messages appear in real-time
- [ ] Send message works with Enter key
- [ ] Mention autocomplete shows user suggestions
- [ ] Messages grouped by date
- [ ] Scroll to bottom on new messages
</verification>

<success_criteria>

- Users can send and receive messages in channels
- @mentions work with autocomplete
- Messages display with author info and timestamps
- Real-time updates when others send messages
- Ready for DMs (Plan 04) and file sharing (Plan 05)
</success_criteria>

<output>
After completion, create `.planning/phases/10-messaging-channels/10-03-SUMMARY.md`
</output>
