---
phase: 10-messaging-channels
plan: 06
type: execute
wave: 4
depends_on: ["10-04", "10-05"]
files_modified: [app/convex/schema.ts, app/convex/notifications.ts, app/src/components/NotificationBell.tsx, app/src/components/NotificationInbox.tsx, app/src/components/Header.tsx, app/src/components/ChannelList.tsx, app/playwright.config.ts, app/e2e/notifications.spec.ts]
autonomous: false
---

<objective>
Add @mention notifications and unread message indicators.

Purpose: Alert users when they're mentioned and help them track unread conversations.
Output: Notification bell with inbox, unread badges on channels.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan summaries
@.planning/phases/10-messaging-channels/10-01-SUMMARY.md
@.planning/phases/10-messaging-channels/10-02-SUMMARY.md
@.planning/phases/10-messaging-channels/10-03-SUMMARY.md
@.planning/phases/10-messaging-channels/10-04-SUMMARY.md

# Existing mention pattern
@app/src/components/MentionInput.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create notifications schema and backend</name>
  <files>app/convex/schema.ts, app/convex/notifications.ts</files>
  <action>
**Schema addition (schema.ts):**
Add notifications table:
- `userId: v.id("users")` - recipient
- `type: v.string()` - "mention" | "dm" (extensible for future types)
- `channelId: v.id("channels")` - where the notification originated
- `messageId: v.id("messages")` - the specific message
- `fromUserId: v.id("users")` - who triggered it
- `isRead: v.boolean()`
- `createdAt: v.number()`
- Indexes: `by_user`, `by_user_read` (for unread queries)

**Backend (notifications.ts):**

**Queries:**
- `listNotifications` - Get user's notifications (paginated, newest first)
- `getUnreadCount` - Count of unread notifications for badge

**Mutations:**
- `createMentionNotification` - Called when message with @[userId] is sent
  - Parse message content for @[userId] mentions
  - Create notification for each mentioned user (except author)
  - Don't duplicate if user already has unread notification for same message
- `markAsRead` - Mark single notification as read
- `markAllAsRead` - Mark all user's notifications as read

**Trigger notifications from message send:**
- Update messages.sendMessage to call createMentionNotification
- Extract @[userId] patterns from content
- Create notification for each mentioned user
  </action>
  <verify>npx convex dev syncs, notifications created on mention</verify>
  <done>Notification backend working</done>
</task>

<task type="auto">
  <name>Task 2: Build notification UI components</name>
  <files>app/src/components/NotificationBell.tsx, app/src/components/NotificationInbox.tsx</files>
  <action>
**NotificationBell.tsx:**
- Bell icon with unread count badge
- Badge shows number (or "9+" if >9)
- Badge hidden when count is 0
- Click opens NotificationInbox dropdown/panel
- Position: relative for dropdown positioning

**NotificationInbox.tsx:**
- Dropdown panel or slide-out panel from bell
- Header: "Notifications" + "Mark all read" button
- List of notifications:
  - Avatar of sender
  - "UserName mentioned you in #channel-name"
  - Time ago ("2m ago", "1h ago", "Yesterday")
  - Unread items have background highlight
  - Click navigates to message in channel
- Empty state: "No notifications"
- "See all" link if list is truncated

**Styling:**
- Dropdown: white background, shadow, max-height with scroll
- Unread: subtle background color (paper variant)
- Bell icon in header style
  </action>
  <verify>Notification bell shows badge, dropdown displays notifications</verify>
  <done>Notification UI components working</done>
</task>

<task type="auto">
  <name>Task 3: Add unread badges and integrate notification bell</name>
  <files>app/src/components/Header.tsx, app/src/components/ChannelList.tsx</files>
  <action>
**Header.tsx:**
- Add NotificationBell component to header, next to user menu
- Position: right side of header, before UserMenu

**ChannelList.tsx:**
- Add unread message badge to each channel
- Query: for each channel, compare lastReadAt with most recent message timestamp
- Show blue dot or count if unread messages exist
- Bold channel name if unread
- Update lastReadAt when channel is opened (already done in Plan 03)

**Unread logic:**
- Channel has unread if: any message.createdAt > member.lastReadAt
- Can use getUnreadCount query from Plan 01 messages.ts
- Show dot for 1-9 unread, number for 10+

**Real-time updates:**
- Badge updates automatically via Convex subscriptions
- Opening channel marks as read, badge disappears
  </action>
  <verify>Unread badges appear on channels, notification bell in header</verify>
  <done>Unread indicators integrated</done>
</task>

<task type="auto">
  <name>Task 3.5: Complete E2E auth infrastructure</name>
  <files>app/playwright.config.ts, app/e2e/notifications.spec.ts</files>
  <action>
**Enable global setup in playwright.config.ts:**
- Uncomment `globalSetup: './e2e/global-setup.ts'`
- Uncomment `storageState: './e2e/.auth/user.json'` in use config
- The global-setup.ts already handles test user creation and auth state persistence

**Rewrite notifications.spec.ts for authenticated E2E testing:**
- Remove filesystem-only tests (component existence checks are unit tests, not E2E)
- Write proper E2E tests that use the authenticated session:
  1. Test notification bell renders in header when authenticated
  2. Test clicking bell opens notification inbox dropdown
  3. Test unread badge displays on channels with new messages
  4. Test clicking notification navigates to message
  5. Test "Mark all read" clears notifications
- Tests run with pre-authenticated storageState from global-setup

**Multi-user testing consideration:**
- For cross-user flows (User A mentions User B), may need separate test
  that logs in as second user mid-test
- Or save manager storageState separately in global-setup
  </action>
  <verify>bun run test -- notifications.spec.ts passes with authenticated context</verify>
  <done>E2E tests run with real auth, notification flow verified automatically</done>
</task>

<task type="checkpoint:e2e" gate="blocking">
  <what-built>Complete notification system with unread indicators across the messaging feature</what-built>
  <e2e-command>cd app && bun run test -- notifications.spec.ts</e2e-command>
  <expected-result>All notification E2E tests pass</expected-result>
  <fallback>If E2E fails, review test output and fix issues before proceeding</fallback>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Notification bell in header with badge
- [ ] Notifications created on @mentions
- [ ] Notification inbox shows list with sender/channel info
- [ ] Click notification navigates to message
- [ ] Unread badges on channels in sidebar
- [ ] Badges update in real-time
- [ ] Mark all as read works
- [ ] E2E auth infrastructure enabled (globalSetup, storageState)
- [ ] E2E tests pass: bun run test -- notifications.spec.ts
</verification>

<success_criteria>

- Users notified when @mentioned
- Notification bell shows unread count
- Channel sidebar shows unread indicators
- All updates are real-time
- Phase 10 complete with full messaging feature
</success_criteria>

<output>
After completion, create `.planning/phases/10-messaging-channels/10-06-SUMMARY.md`
</output>
