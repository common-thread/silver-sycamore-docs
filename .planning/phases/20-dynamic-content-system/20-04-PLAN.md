---
phase: 20-dynamic-content-system
plan: 04
type: execute
wave: 2
depends_on: ["20-01"]
files_modified: [app/convex/sharing.ts, app/src/components/ShareLinkDialog.tsx, app/src/app/share/[token]/page.tsx]
autonomous: true
---

<objective>
Build sharing system — create share links (internal to staff, external via anonymous URL), access validation, and public share page for external completions.

Purpose: Enable staff to share procedures, checklists, and forms internally with colleagues or externally via anonymous links (like Google Forms sharing).
Output: Sharing API + share dialog component + public share page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-dynamic-content-system/20-RESEARCH.md

@app/convex/schema.ts
@app/src/components/ShareDialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sharing.ts with link management</name>
  <files>app/convex/sharing.ts</files>
  <action>
Create new Convex module `app/convex/sharing.ts` for share link management.

**createShareLink mutation:**
- Args: `{ documentId, shareType: "internal" | "external", sharedWithUserIds?: Id<"users">[], routeResultsTo: Id<"users">[], expiresAt?, maxUses? }`
- Validates document exists and has dynamic contentType (procedure/checklist/form)
- Generates secure token: `crypto.randomUUID()`
- Creates shareLinks record
- Returns the share token

**getShareLink query:**
- Args: `{ token: string }`
- Returns share link details (or null if not found/expired)
- Checks expiration and usage limits
- Does NOT return document content (just link metadata)

**accessViaShareLink query:**
- Args: `{ token: string }`
- Validates link (exists, not expired, under usage limit)
- For internal links: verifies user is authenticated AND in sharedWithUserIds
- For external links: allows anyone (no auth required)
- Returns document content if access granted
- Increments useCount on successful access (via separate mutation)

**incrementShareLinkUsage mutation:**
- Args: `{ token: string }`
- Increments useCount atomically
- Called when someone accesses via share link

**getDocumentShareLinks query:**
- Args: `{ documentId }`
- Returns all share links created by current user for this document
- Used to show existing shares in dialog

**revokeShareLink mutation:**
- Args: `{ token: string }`
- Deletes the share link (only owner can revoke)
- Used to disable sharing
  </action>
  <verify>npx convex dev --once (module compiles and deploys)</verify>
  <done>Share link CRUD operations work, access validation correct for internal vs external</done>
</task>

<task type="auto">
  <name>Task 2: Create ShareLinkDialog component</name>
  <files>app/src/components/ShareLinkDialog.tsx</files>
  <action>
Create `ShareLinkDialog.tsx` — dialog for creating and managing share links.

**Props:**
```typescript
interface ShareLinkDialogProps {
  documentId: string;
  documentTitle: string;
  isOpen: boolean;
  onClose: () => void;
}
```

**Behavior:**
1. Show existing share links for this document
2. Create new link form:
   - Share type toggle: Internal / External
   - For internal: UserPicker to select recipients
   - Route results to: UserPicker (required, defaults to self)
   - Optional: expiration date, max uses
3. Copy link button for each existing link
4. Revoke button for each link

**Wireframe:**
```
+--------------------------------------------+
|  Share: [Document Title]              [X]  |
+--------------------------------------------+
|  Create New Share Link                     |
|                                            |
|  Type: (•) Internal  ( ) External          |
|                                            |
|  [Internal only]                           |
|  Share with: [Select users...]             |
|                                            |
|  Route results to: [Select users...]       |
|                                            |
|  [Advanced ▼]                              |
|    Expires: [Never ▼]                      |
|    Max uses: [Unlimited]                   |
|                                            |
|  [Create Link]                             |
+--------------------------------------------+
|  Existing Links                            |
|  +--------------------------------------+  |
|  | Internal • 3 users • Created today  |  |
|  | [Copy Link] [Revoke]                |  |
|  +--------------------------------------+  |
+--------------------------------------------+
```

**Styling:**
- Modal dialog matching existing ShareDialog pattern
- Use Select component for dropdowns
- Use UserPicker for user selection
- Button styling matches brand
  </action>
  <verify>bun run build (component compiles)</verify>
  <done>ShareLinkDialog allows creating internal/external links with proper UI</done>
</task>

<task type="auto">
  <name>Task 3: Create public share page</name>
  <files>app/src/app/share/[token]/page.tsx</files>
  <action>
Create public share page at `/share/[token]` for accessing shared content.

**Route:** `app/src/app/share/[token]/page.tsx`

**Behavior:**
1. Extract token from URL params
2. Query `accessViaShareLink` with token
3. Handle error states: invalid link, expired, usage exceeded, access denied
4. If valid, render document using appropriate renderer:
   - procedure → ProcedureSteps
   - checklist → ChecklistView
   - form → FormRenderer (existing)
5. For external (anonymous) access:
   - Don't require login
   - Track session via sessionId for completion persistence
   - Show "Shared by [user]" attribution

**Error states:**
- Invalid link: "This link is invalid or has been revoked"
- Expired: "This link has expired"
- Usage exceeded: "This link has reached its usage limit"
- Access denied (internal): "You don't have access to this link. Please log in."

**Wireframe:**
```
+------------------------------------------------+
|  Shared: [Document Title]                      |
|  Shared by: [User Name]                        |
+------------------------------------------------+
|                                                |
|  [Content rendered via appropriate renderer]   |
|                                                |
+------------------------------------------------+
|  Powered by Silver Sycamore Staff Hub          |
+------------------------------------------------+
```

**Anonymous session handling:**
- Generate sessionId if not authenticated
- Store in localStorage or use Convex Anonymous provider
- Pass sessionId to instance creation for completion tracking
  </action>
  <verify>bun run build (page compiles and route works)</verify>
  <done>Public share page renders content for valid links, handles errors gracefully</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx convex dev --once` deploys sharing.ts
- [ ] `bun run build` succeeds
- [ ] Share links can be created (internal and external)
- [ ] Public share page accessible at /share/[token]
- [ ] Access control works correctly
</verification>

<success_criteria>

- All tasks completed
- Internal shares require login + being in recipient list
- External shares work without login
- Share dialog integrates with existing UI patterns
</success_criteria>

<output>
After completion, create `.planning/phases/20-dynamic-content-system/20-04-SUMMARY.md`
</output>
