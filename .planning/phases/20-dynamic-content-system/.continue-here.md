---
phase: 20-dynamic-content-system
task: post-completion-bugfix
total_tasks: 5
status: in_progress
last_updated: 2026-01-17T17:40:00
---

<current_state>
Phase 20 plans are complete, but during verification discovered and fixed a bug with anonymous procedure tracking. Also uncovered a content data issue that needs resolution before Phase 20 can truly be considered "done".

We were discussing the content issue with the user when they paused.
</current_state>

<completed_work>

- Plan 20-01: Schema Foundation - Complete
- Plan 20-02: Completion Tracking - Complete
- Plan 20-03: Activity System - Complete
- Plan 20-04: Sharing System - Complete
- Plan 20-05: Integration - Complete
- **Bug Fix**: Anonymous procedure/checklist tracking - FIXED AND COMMITTED

The bug fix (commit `8f1ba4f`) addressed:
- `getInstanceForDocument` query now accepts `sessionId` parameter
- `startInstance` mutation now accepts `sessionId` parameter
- `completeStep` mutation now accepts `sessionId` parameter for access verification
- Client-side sessionId generated in localStorage (`silver-sycamore-session-id`)
- Added `by_session_source` index to schema
- Updated ProcedureSteps and ChecklistView components to pass sessionId
</completed_work>

<remaining_work>

**Content Data Issue (discovered during verification):**

2 documents are typed as "procedure" but are binary DOCX files with no parseable content:
- Pre-Wedding To Do List (pre-wedding-todo.docx) - shows "0 steps"
- Wedding Processional (wedding-processional.docx) - shows "0 steps"

Their content is placeholder text like `[Binary file: pre-wedding-todo.docx]`, so the step parser finds no h2 headers.

**Options presented to user:**
1. Re-classify as "reference" - show as downloadable documents
2. Convert DOCX content to markdown - extract actual text
3. Detect binary and show download link instead of "Start Procedure"

User had not chosen an option when session paused.
</remaining_work>

<decisions_made>

- **Bug root cause**: startInstance mutation worked for anonymous users, but getInstanceForDocument returned null because it only checked auth identity, not client sessionId
- **Fix approach**: Added optional sessionId parameter to all relevant queries/mutations, client generates localStorage ID
- **Port change**: Dev server changed from 3001 to 3000 (committed in `2b790e6`)
</decisions_made>

<blockers>

- **Content type mismatch**: Binary DOCX files classified as "procedure" cannot display interactive steps
- Need user decision on how to handle binary procedures
</blockers>

<context>
Phase 20 delivered the Dynamic Content System infrastructure correctly. The bug was in how anonymous users were handled - mutations worked but queries didn't return results because sessionId matching wasn't implemented.

The content issue is a data problem from Phase 18's content classification - some documents were classified as "procedure" based on their purpose, but they're binary files that can't provide the actual procedure content.

The UI correctly shows "0 steps" for these binary files because there's no markdown to parse. The user expected to see actual procedure content.
</context>

<files_modified>

**Committed:**
- `8f1ba4f` - fix(20): enable anonymous procedure/checklist tracking
  - app/convex/dynamicContent.ts
  - app/convex/schema.ts
  - app/convex/_generated/api.d.ts
  - app/src/components/ProcedureSteps.tsx
  - app/src/components/ChecklistView.tsx
- `2b790e6` - chore: change dev port to 3000
  - app/package.json

**Uncommitted:** None
</files_modified>

<next_action>
1. Get user decision on handling binary DOCX "procedure" documents
2. Implement chosen fix (likely re-classify as "reference" or show download UI)
3. Update ROADMAP.md and STATE.md to reflect Phase 20 status
4. Consider adding this as 20-FIX plan or include in Phase 21
</next_action>
