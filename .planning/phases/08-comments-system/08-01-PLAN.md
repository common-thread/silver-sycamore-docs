---
phase: 08-comments-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [app/convex/schema.ts, app/convex/comments.ts]
autonomous: true
---

<objective>
Create the database schema and backend API for threaded document comments.

Purpose: Enable staff to discuss documents, ask questions, and share context directly on pages.
Output: Comments table in schema, full CRUD API in convex/comments.ts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@app/convex/schema.ts
@app/convex/users.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add comments table to schema</name>
  <files>app/convex/schema.ts</files>
  <action>
Add a `comments` table with:
- `documentId: v.id("documents")` - the wiki document being commented on
- `personalDocumentId: v.optional(v.id("personalDocuments"))` - if commenting on personal doc (one or the other)
- `authorId: v.id("users")` - who wrote the comment
- `parentId: v.optional(v.id("comments"))` - for threading (null = top-level, set = reply)
- `content: v.string()` - the comment text (may contain @mentions as `@[userId]`)
- `createdAt: v.number()`
- `updatedAt: v.number()`

Indexes:
- `by_document: ["documentId"]` - get all comments for a wiki doc
- `by_personal_document: ["personalDocumentId"]` - get comments on personal docs
- `by_parent: ["parentId"]` - get replies to a comment
- `by_author: ["authorId"]` - user's comment history

Note: Comments support both wiki documents and personal documents. The querying will determine which field to use.
  </action>
  <verify>Run `npx convex dev` and confirm schema deploys without errors</verify>
  <done>Comments table exists with all fields and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create comment CRUD operations</name>
  <files>app/convex/comments.ts</files>
  <action>
Create `app/convex/comments.ts` with:

**Queries:**
- `getByDocument({ documentId })` - Get all comments for a wiki document, sorted by createdAt ascending. Return comments with author info (join userProfiles for displayName, avatar).
- `getByPersonalDocument({ personalDocumentId })` - Same for personal docs.
- `getThread({ parentId })` - Get replies to a specific comment (for lazy-loading threads).

**Mutations:**
- `add({ documentId?, personalDocumentId?, parentId?, content })` - Create comment. Require auth. Set authorId from session. Validate exactly one of documentId/personalDocumentId is provided.
- `update({ commentId, content })` - Edit comment. Only author can edit. Update updatedAt timestamp.
- `remove({ commentId })` - Delete comment. Author OR admin/manager can delete. When deleting parent, also delete child replies (cascade).

Follow existing patterns from convex/users.ts for auth checks:
- Get identity via `ctx.auth.getUserIdentity()`
- Find user via email match
- Check role for permission-gated actions

Return author info with comments: `{ ...comment, author: { id, displayName, avatarUrl } }`
  </action>
  <verify>Test via Convex dashboard: create comment, list comments, edit, delete</verify>
  <done>All CRUD operations work: add returns new comment, getByDocument returns array with author info, update modifies content, remove cascades to replies</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx convex dev` runs without schema errors
- [ ] Can create a comment via Convex dashboard or function tester
- [ ] Can list comments for a document
- [ ] Can edit own comment
- [ ] Can delete own comment
- [ ] Delete cascade removes replies
</verification>

<success_criteria>

- Comments table in schema with correct fields and indexes
- CRUD operations in convex/comments.ts
- Auth checks on all mutations
- Cascade delete for replies
- Author info returned with comments
</success_criteria>

<output>
After completion, create `.planning/phases/08-comments-system/08-01-SUMMARY.md`
</output>
