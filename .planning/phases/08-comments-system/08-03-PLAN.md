---
phase: 08-comments-system
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified: [app/src/components/MentionInput.tsx, app/src/components/CommentSection.tsx, app/src/components/CommentItem.tsx]
autonomous: true
---

<objective>
Add @mention functionality to comments with autocomplete and styled rendering.

Purpose: Allow staff to notify and reference colleagues directly in comments.
Output: MentionInput component with user autocomplete, mentions rendered as styled links in comments.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/08-comments-system/08-02-SUMMARY.md

@app/convex/users.ts
@app/src/components/UserPicker.tsx
@app/src/components/CommentSection.tsx
@app/src/components/CommentItem.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MentionInput component with autocomplete</name>
  <files>app/src/components/MentionInput.tsx</files>
  <action>
Create a textarea that detects @mentions and shows user autocomplete:

**Detection logic:**
- On input change, scan text for `@` followed by word characters
- When cursor is positioned after `@xxx`, extract `xxx` as search query
- If query length >= 2, show autocomplete dropdown

**Autocomplete dropdown:**
- Position dropdown below the @mention trigger position (not at textarea bottom)
- Use existing `api.users.searchUsers` query (already built in Phase 7)
- Show user results: displayName/name, email below
- Keyboard navigation: Arrow up/down to select, Enter to insert, Escape to close
- Click to insert

**Insertion:**
- When user is selected, replace `@xxx` with `@[userId]` in the text
- Store mapping of userId -> displayName for display purposes
- Show as styled "pill" in the textarea preview (or just bold text)
- Format: Store `@[abc123def]` in content, render as "@John Smith"

**Component API:**
```typescript
interface MentionInputProps {
  value: string;
  onChange: (value: string) => void;
  placeholder?: string;
  rows?: number;
}
```

Follow UserPicker patterns for dropdown styling and debouncing.
  </action>
  <verify>Type "@jo" in MentionInput, see autocomplete with matching users. Select one, see @[userId] inserted.</verify>
  <done>MentionInput detects @, shows autocomplete, inserts @[userId] format on selection</done>
</task>

<task type="auto">
  <name>Task 2: Parse and render mentions in comment display</name>
  <files>app/src/components/CommentItem.tsx, app/src/components/CommentSection.tsx</files>
  <action>
**Update CommentSection to use MentionInput:**
- Replace plain textarea in "Add comment" form with MentionInput
- Replace inline reply textareas with MentionInput

**Create mention parser utility (in CommentItem or separate util):**
```typescript
function parseMentions(content: string): (string | { type: 'mention', userId: string })[]
```
- Parse `@[userId]` patterns from content
- Return array of plain text strings and mention objects
- Example: "Hey @[abc123] check this" â†’ ["Hey ", { type: 'mention', userId: 'abc123' }, " check this"]

**Render mentions in CommentItem:**
- For each mention object, fetch user displayName (batch query or cache)
- Render as styled span: `<span style="color: var(--color-accent); font-weight: 500">@DisplayName</span>`
- Make mention clickable (future: navigate to user profile, for now just highlight)

**Performance consideration:**
- Batch user lookups: collect all userIds from all visible comments, query once
- Add `getUsersById({ userIds: Id<"users">[] })` query to convex/users.ts if needed
- Cache results in component state to avoid re-fetching

**Edge cases:**
- Handle deleted users gracefully: show "@Unknown User" if lookup fails
- Handle malformed @[xxx] that doesn't match valid userId
  </action>
  <verify>Create comment with @mention, see it rendered as styled "@DisplayName" in comment list</verify>
  <done>Comments with @[userId] render as styled mention with user's display name. All comment forms use MentionInput.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] MentionInput shows autocomplete when typing @
- [ ] Can search and select user from dropdown
- [ ] Selected mention stored as @[userId] in content
- [ ] Comments render @[userId] as styled "@DisplayName"
- [ ] Keyboard navigation works (arrows, enter, escape)
- [ ] Deleted/invalid mentions show fallback
</verification>

<success_criteria>

- MentionInput component with working autocomplete
- @[userId] format stored in database
- Mentions render as styled links with display names
- All comment forms upgraded to use MentionInput
</success_criteria>

<output>
After completion, create `.planning/phases/08-comments-system/08-03-SUMMARY.md`
</output>
