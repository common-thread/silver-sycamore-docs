---
phase: 08-comments-system
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified: [app/src/components/CommentSection.tsx, app/src/components/CommentItem.tsx, app/src/app/[category]/[slug]/page.tsx]
autonomous: true
---

<objective>
Build the UI components for displaying and adding threaded comments on documents.

Purpose: Allow staff to read, post, and reply to comments directly on document pages.
Output: CommentSection and CommentItem components, integrated into wiki document pages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/08-comments-system/08-01-SUMMARY.md

@app/convex/comments.ts
@app/src/components/DocumentViewer.tsx
@app/src/app/[category]/[slug]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comment display and form components</name>
  <files>app/src/components/CommentSection.tsx, app/src/components/CommentItem.tsx</files>
  <action>
**CommentItem.tsx:**
Display a single comment with:
- Author avatar (circle with initials if no avatarUrl) + displayName/email
- Comment content (plain text for now, mentions handled in 08-03)
- Timestamp (relative: "2 hours ago", "yesterday", etc.)
- Actions: Reply button, Edit (if author), Delete (if author or admin/manager)
- Nested replies indented below (recursive CommentItem rendering)
- Collapse/expand toggle for threads with >2 replies

Use existing design system:
- `--font-body` for text
- `--color-ink`, `--color-ink-muted` for hierarchy
- `--color-border` for separators
- Subtle hover states on actions

**CommentSection.tsx:**
Container component that:
- Props: `{ documentId?: Id<"documents">, personalDocumentId?: Id<"personalDocuments"> }`
- Fetches comments via `useQuery(api.comments.getByDocument, { documentId })` or personal variant
- Renders top-level comments (parentId === undefined) as CommentItem
- Includes "Add a comment" form at bottom (textarea + Submit button)
- Form state: content text, submitting boolean
- On submit: call `useMutation(api.comments.add)`, clear form
- Show comment count in header: "3 Comments" / "No comments yet"

Inline reply forms:
- When user clicks Reply on CommentItem, show textarea inline below that comment
- Submit creates comment with parentId set
  </action>
  <verify>Render CommentSection in isolation (Storybook or test page), confirm layout matches design system</verify>
  <done>CommentItem shows author, content, timestamp, actions. CommentSection lists comments with add form. Reply creates nested thread.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate comments into document pages</name>
  <files>app/src/app/[category]/[slug]/page.tsx</files>
  <action>
Add CommentSection below the DocumentViewer in the wiki document page:

1. Import CommentSection component
2. After DocumentViewer render, add a section with:
   - Horizontal divider (1px border-top, spacing)
   - CommentSection with documentId={document._id}
3. Only show comments section for authenticated users (check via useQuery for currentUser)
4. Non-authenticated visitors see a message: "Sign in to view and add comments"

Layout considerations:
- Comments section has max-width matching document content area
- Adequate vertical spacing (32-48px) between document and comments
- Section heading "Discussion" styled with `--font-display`
  </action>
  <verify>Navigate to wiki document, see comments section below content. Can add comment, see it appear.</verify>
  <done>Wiki documents show CommentSection. Adding comment works. Reply threading works.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] CommentSection renders on document pages
- [ ] Can post a new comment, appears immediately
- [ ] Can reply to comment, shows nested
- [ ] Can edit own comment
- [ ] Can delete own comment
- [ ] Timestamps display correctly
- [ ] Non-authenticated users see signin prompt
</verification>

<success_criteria>

- CommentSection and CommentItem components created
- Integrated into wiki document pages
- Full add/reply/edit/delete flow works
- Design matches existing system aesthetic
</success_criteria>

<output>
After completion, create `.planning/phases/08-comments-system/08-02-SUMMARY.md`
</output>
