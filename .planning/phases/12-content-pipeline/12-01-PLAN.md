---
phase: 12-content-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/scripts/lib/indexParser.ts
  - app/scripts/import-documents.ts
autonomous: true
---

<objective>
Implement deterministic content seeding by parsing index.md tables for document metadata.

Purpose: Replace heuristic description extraction with authoritative data from index.md files, ensuring consistent and accurate document titles/descriptions across imports.
Output: Updated import script that uses parsed index.md metadata as source of truth.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Source files
@app/scripts/import-documents.ts
@docs/services/index.md
@docs/staff/index.md
@docs/clients/index.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create index.md parser utility</name>
  <files>app/scripts/lib/indexParser.ts</files>
  <action>
Create a parser module that extracts document metadata from index.md files.

**Input:** Path to docs/ directory
**Output:** Map of document path â†’ {title, description}

**Parsing logic:**
1. Read each category's index.md (services, clients, staff, operations, deliverables)
2. Track current subcategory from `## Heading` lines
3. Parse markdown tables: `| [Title](path) | Description |`
   - Extract title from link text `[Title]`
   - Extract relative path from link URL `(path)`
   - Extract description from second column
4. Parse markdown lists: `- [Title](path)` (Room Layouts section)
   - Extract title and path, description is undefined
5. Skip external URLs (https://)
6. Normalize paths: strip .html extension, resolve relative to category

**Data structure:**
```typescript
interface DocMetadata {
  title: string;
  description?: string;
  subcategory: string;
}

// Return Map<string, DocMetadata> keyed by full path like "services/wedding-packages/package-dream"
```

**Edge cases to handle:**
- External links (skip)
- .html extensions (strip for matching)
- Nested subcategories in Room Layouts (layouts/hall/head-table)
- Missing description in list items (use undefined, not fallback)
  </action>
  <verify>Write a simple test inline: parse services/index.md and log output, confirm "Dream Package" maps to correct path with description "Premium 5-hour ceremony and reception"</verify>
  <done>Parser correctly extracts title, description, subcategory for all documents in all 5 index.md files. External links skipped.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate parser into import script</name>
  <files>app/scripts/import-documents.ts</files>
  <action>
Update import-documents.ts to use parsed metadata from index.md files.

**Changes:**
1. Import the parser: `import { parseAllIndexFiles } from './lib/indexParser'`
2. At script start, call parser to build metadata map
3. When processing each file:
   - Build lookup key from category + relative path (e.g., "services/wedding-packages/package-dream")
   - Look up metadata in map
   - If found: use parsed title and description
   - If not found: fall back to existing heuristics (titleFromFilename, extractDescription)
4. Log when using parsed vs. heuristic metadata for debugging
5. Remove or simplify the heuristic functions (keep as fallback only)

**Key insight:** The import script already derives subcategory from directory name. The lookup key should be: `{category}/{subcategory}/{filename-without-extension}` or `{category}/{filename-without-extension}` if no subcategory.

**Do NOT:**
- Remove the fallback entirely (some files may not be in index.md)
- Change the Convex mutation calls
- Modify the file traversal logic
  </action>
  <verify>Run `cd app && source .env.local && bun run scripts/import-documents.ts` and check logs show "using parsed metadata" for documents listed in index.md</verify>
  <done>Import script uses parsed metadata when available, falls back to heuristics otherwise. Logs indicate which source was used for each document.</done>
</task>

<task type="auto">
  <name>Task 3: Verify import accuracy</name>
  <files>app/scripts/import-documents.ts</files>
  <action>
Run a full import and verify the metadata quality.

**Steps:**
1. Run full import: `cd app && source .env.local && bun run scripts/import-documents.ts`
2. Check Convex dashboard or query a few documents to verify:
   - "Dream Package" has title "Dream Package" (not "Package Dream" from filename)
   - Description is "Premium 5-hour ceremony and reception" (not heuristic extraction)
3. Check documents not in index.md still import with reasonable fallback metadata
4. Verify no regressions: same document count as before, no import errors

**If issues found:** Debug parser or integration, fix, re-run import.
  </action>
  <verify>Query Convex: documents have correct titles matching index.md link text, descriptions matching table second column</verify>
  <done>All documents import successfully. Titles and descriptions match index.md source of truth where available.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Parser handles all 5 index.md files without errors
- [ ] Import script integrates parser and uses metadata map
- [ ] Full import completes without errors
- [ ] Spot-check: "Dream Package" title/description match index.md
- [ ] Spot-check: Room layout documents import despite list format
- [ ] No TypeScript errors: `cd app && npx tsc --noEmit`
</verification>

<success_criteria>

- Parser utility extracts metadata from all index.md files
- Import script uses parsed metadata as primary source
- Fallback to heuristics works for unlisted documents
- Document titles/descriptions are deterministic and match source of truth
</success_criteria>

<output>
After completion, create `.planning/phases/12-content-pipeline/12-01-SUMMARY.md`
</output>
