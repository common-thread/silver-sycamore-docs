---
phase: 11-forms-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [app/convex/schema.ts, app/convex/forms.ts]
autonomous: true
---

<objective>
Enhance form schema and create comprehensive CRUD mutations for the forms system.

Purpose: Establish the data foundation for staff-managed forms with response routing, supporting the full form builder workflow.
Output: Enhanced schema with routing fields, complete forms.ts with CRUD operations and queries.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/02-form-schemas.md

@app/convex/schema.ts
@app/convex/channels.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance form schema for builder and routing</name>
  <files>app/convex/schema.ts</files>
  <action>
Update formSchemas table to support the form builder:
- Add `ownerId: v.id("users")` - who created/owns the form
- Add `description: v.optional(v.string())` - form description
- Add `isPublished: v.boolean()` - whether form is active
- Add `createdAt: v.number()`, `updatedAt: v.number()` - timestamps
- Add index `by_owner` on ownerId

Update formSubmissions table for response routing:
- Add `formSchemaId: v.id("formSchemas")` (keep existing)
- Add `respondentEmail: v.optional(v.string())` - who filled it out
- Add `respondentName: v.optional(v.string())` - respondent name
- Change `submittedBy` to `sentById: v.optional(v.id("users"))` - staff who sent it
- Add `routeToUserIds: v.optional(v.array(v.id("users")))` - additional recipients
- Add index `by_sentBy` on sentById
- Add index `by_schema` on formSchemaId

Keep existing indexes. Follow established patterns from channels/messages schema.
  </action>
  <verify>npx convex dev --once (schema validates)</verify>
  <done>Schema has ownerId, routing fields, proper indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create forms.ts with CRUD mutations</name>
  <files>app/convex/forms.ts</files>
  <action>
Create app/convex/forms.ts with full CRUD operations:

**Queries:**
- `list` - Get all forms for current user (owned by them)
- `listAll` - Get all published forms (for staff to browse)
- `get` - Get single form by ID
- `getByFormId` - Get form by string formId (for public access)
- `getSubmissions` - Get submissions for a form (owner only)
- `getSubmission` - Get single submission by ID
- `getMyReceivedSubmissions` - Submissions routed to current user

**Mutations:**
- `create` - Create new form (requires auth, sets ownerId)
- `update` - Update form (owner only)
- `publish` / `unpublish` - Toggle isPublished
- `delete` - Delete form (owner only, soft delete or hard)
- `submitResponse` - Public mutation for form submission (no auth required)
- `deleteSubmission` - Delete a submission (owner only)

**Patterns to follow:**
- Use `getAuthUserId` from convex/auth for auth checks
- Owner check pattern from personalFolders.ts
- Timestamp pattern: `createdAt: Date.now()`, `updatedAt: Date.now()`
- Return created/updated record from mutations

**Important:** `submitResponse` must NOT require auth - it's for external respondents.
  </action>
  <verify>npx convex dev --once (no type errors)</verify>
  <done>All queries and mutations working, owner checks in place, public submission works</done>
</task>

<task type="auto">
  <name>Task 3: Add form field type validation helper</name>
  <files>app/convex/forms.ts</files>
  <action>
Add a helper function to validate form field definitions:

```typescript
// Field type definition (stored as JSON string in schema)
type FormField = {
  name: string;
  type: "text" | "textarea" | "number" | "date" | "time" | "email" | "tel" | "select" | "multiselect" | "checkbox" | "file";
  label: string;
  required: boolean;
  options?: string[]; // For select/multiselect
  placeholder?: string;
};

// Helper to parse and validate fields JSON
function parseFormFields(fieldsJson: string): FormField[] {
  // Parse and validate structure
}
```

This helper will be used by the renderer to interpret the `fields` JSON string.
Use in `get` and `getByFormId` queries to return parsed fields alongside raw data.
  </action>
  <verify>npx convex dev --once</verify>
  <done>Field type definitions exported, parse helper available</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx convex dev --once` succeeds without errors
- [ ] Schema has all new fields and indexes
- [ ] forms.ts exports all queries and mutations
- [ ] Public submitResponse works without auth
- [ ] Owner-only mutations reject unauthorized users
</verification>

<success_criteria>
- All tasks completed
- Schema enhanced with routing and builder fields
- Full CRUD available for forms
- Field type definitions ready for renderer
</success_criteria>

<output>
After completion, create `.planning/phases/11-forms-system/11-01-SUMMARY.md`
</output>
