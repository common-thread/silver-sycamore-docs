---
phase: 11-forms-system
plan: 04
type: execute
wave: 3
depends_on: ["11-01", "11-02", "11-03"]
files_modified: [app/src/components/FormShareDialog.tsx, app/src/components/FormBuilder.tsx, app/convex/forms.ts]
autonomous: true
---

<objective>
Implement form delivery via email and shareable links with response routing configuration.

Purpose: Enable staff to send forms to clients and configure who receives the responses.
Output: Share dialog with email/link options, response routing setup.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-forms-system/11-CONTEXT.md

@app/src/components/ShareDialog.tsx
@app/src/components/UserPicker.tsx
@app/src/components/StartDMDialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FormShareDialog component</name>
  <files>app/src/components/FormShareDialog.tsx</files>
  <wireframe>
+--------------------------------------------------+
|  Share Form                                   [x]|
+--------------------------------------------------+
|                                                  |
|  Shareable Link                                  |
|  +------------------------------------------+   |
|  | https://app.com/f/booking-wedding   [Copy]|   |
|  +------------------------------------------+   |
|                                                  |
|  --- OR ---                                      |
|                                                  |
|  Send via Email                                  |
|  Recipient Email:                                |
|  [____________________]                          |
|                                                  |
|  Recipient Name (optional):                      |
|  [____________________]                          |
|                                                  |
|  Response Routing                                |
|  Responses will be sent to you and:             |
|  [+ Add recipient]                               |
|  - John Manager [x]                              |
|  - Sarah Admin [x]                               |
|                                                  |
|                    [Cancel]  [Send Email]        |
+--------------------------------------------------+
  </wireframe>
  <action>
Create FormShareDialog.tsx:

Props:
- `formId`: The form's string ID
- `formTitle`: For display and email subject
- `isOpen`, `onClose`: Dialog state

Features:
1. **Shareable Link Section:**
   - Display full URL: `{window.location.origin}/f/{formId}`
   - Copy to clipboard button with success feedback
   - Link works for anyone (public)

2. **Email Section:**
   - Recipient email input (required for email send)
   - Recipient name input (optional)
   - For MVP: Copy a pre-formatted email body to clipboard
   - Later: Could integrate with email service

3. **Response Routing:**
   - Current user automatically included
   - UserPicker to add additional staff members
   - Selected users stored with form send record
   - Use pattern from ShareDialog.tsx for user selection

4. **Send Action:**
   - Creates a "send record" in database (track who sent to whom)
   - Stores routing configuration
   - Opens email client with mailto: link (MVP approach)

Use Dialog pattern from existing components.
  </action>
  <verify>bun run build (no type errors)</verify>
  <done>Share dialog opens, copy link works, can configure routing</done>
</task>

<task type="auto">
  <name>Task 2: Add formSends table and mutations</name>
  <files>app/convex/schema.ts, app/convex/forms.ts</files>
  <action>
Add tracking for form sends:

**Schema addition (schema.ts):**
```typescript
formSends: defineTable({
  formSchemaId: v.id("formSchemas"),
  sentById: v.id("users"), // Staff who sent it
  recipientEmail: v.string(), // Who it was sent to
  recipientName: v.optional(v.string()),
  routeToUserIds: v.array(v.id("users")), // Additional recipients for responses
  sentAt: v.number(),
})
  .index("by_form", ["formSchemaId"])
  .index("by_sender", ["sentById"]),
```

**Mutations (forms.ts):**
- `sendForm`: Create send record with routing config
- `getSends`: Get send history for a form (owner only)

**Update submitResponse:**
- Accept optional `sendId` to link submission to specific send
- Copy `routeToUserIds` from send record to submission

This enables tracking who sent forms to whom and ensures responses go to right people.
  </action>
  <verify>npx convex dev --once</verify>
  <done>formSends table exists, sendForm mutation works</done>
</task>

<task type="auto">
  <name>Task 3: Integrate share dialog into form builder</name>
  <files>app/src/components/FormBuilder.tsx, app/src/app/forms/[formId]/edit/page.tsx</files>
  <action>
Add share functionality to form editing:

1. **In FormBuilder or edit page:**
   - Add "Share" button (only visible for published forms)
   - Opens FormShareDialog with form details
   - Disabled with tooltip for unpublished forms: "Publish form to share"

2. **In forms list page (forms/page.tsx):**
   - Add share icon/button for each published form
   - Quick access to sharing without opening edit page

3. **Visual states:**
   - Published forms: Share button enabled
   - Draft forms: Share button disabled with explanation

Follow button patterns from existing pages.
Share button should be prominent for easy access.
  </action>
  <verify>bun run build && bun run dev</verify>
  <done>Share button appears on published forms, dialog opens correctly</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `bun run build` succeeds
- [ ] `npx convex dev --once` succeeds
- [ ] Share dialog opens with correct form link
- [ ] Copy to clipboard works
- [ ] Can add response routing recipients
- [ ] formSends records are created
</verification>

<success_criteria>
- All tasks completed
- Staff can share forms via link or email
- Response routing is configurable
- Send history is tracked
</success_criteria>

<output>
After completion, create `.planning/phases/11-forms-system/11-04-SUMMARY.md`
</output>
