---
phase: 07-folder-sharing
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified: [app/src/components/ShareDialog.tsx, app/src/components/UserPicker.tsx, app/convex/users.ts]
autonomous: true
---

<objective>
Build Google Drive-style share dialog with user picker and permission management.

Purpose: Enable folder owners to share their folders with others via an intuitive modal interface.
Output: ShareDialog and UserPicker components following the project's Typeform-inspired design system.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-folder-sharing/07-CONTEXT.md
@.planning/phases/07-folder-sharing/07-01-SUMMARY.md

@app/src/components/FolderPicker.tsx
@app/convex/folderShares.ts
@app/convex/shareGroups.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add user search query</name>
  <files>app/convex/users.ts</files>
  <action>
Add a new query to users.ts for searching users by name/email:

```typescript
// Search users by name or email (for user picker)
export const searchUsers = query({
  args: {
    query: v.string(),
    limit: v.optional(v.number()),
  },
  handler: async (ctx, args) => {
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) return [];

    const searchQuery = args.query.toLowerCase();
    const limit = args.limit ?? 10;

    // Get all users (small team, full scan is fine)
    const allUsers = await ctx.db.query("users").collect();

    // Filter by email or name containing query
    const matches = allUsers
      .filter((user) => {
        const email = (user.email ?? "").toLowerCase();
        const name = (user.name ?? "").toLowerCase();
        return email.includes(searchQuery) || name.includes(searchQuery);
      })
      .slice(0, limit);

    // Get profiles for display names
    const usersWithProfiles = await Promise.all(
      matches.map(async (user) => {
        const profile = await ctx.db
          .query("userProfiles")
          .withIndex("by_userId", (q) => q.eq("userId", user._id))
          .first();

        return {
          id: user._id,
          email: user.email,
          name: user.name,
          displayName: profile?.displayName,
        };
      })
    );

    return usersWithProfiles;
  },
});
```

Note: For small teams (<100 users), full scan with client-side filter is acceptable. For larger teams, would need search index.
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>searchUsers query returns filtered user list with profiles</done>
</task>

<task type="auto">
  <name>Task 2: Create UserPicker component</name>
  <files>app/src/components/UserPicker.tsx</files>
  <action>
Create app/src/components/UserPicker.tsx - an autocomplete component for selecting users:

**Props:**
```typescript
interface UserPickerProps {
  onSelect: (user: { id: Id<"users">; email: string; name?: string; displayName?: string }) => void;
  placeholder?: string;
  excludeIds?: Id<"users">[]; // Users to exclude from results (already shared with)
}
```

**Implementation:**
1. Text input with debounced search (300ms)
2. Dropdown showing matching users below input
3. Each result shows: displayName or name, with email below in smaller text
4. Click result calls onSelect and clears input
5. Click outside closes dropdown
6. Empty state when no matches

**Styling:** Match FolderPicker.tsx patterns:
- var(--font-body) for text
- var(--color-ink), var(--color-ink-light), var(--color-ink-muted)
- var(--color-border), var(--color-surface), var(--color-background)
- 2px border-radius
- 0.8125rem font size

**Debounce pattern:**
```typescript
const [query, setQuery] = useState("");
const [debouncedQuery, setDebouncedQuery] = useState("");

useEffect(() => {
  const timer = setTimeout(() => setDebouncedQuery(query), 300);
  return () => clearTimeout(timer);
}, [query]);

const results = useQuery(
  api.users.searchUsers,
  debouncedQuery.length >= 2 ? { query: debouncedQuery } : "skip"
);
```

Filter out excludeIds from results before rendering.
  </action>
  <verify>Component renders without errors, search triggers after 300ms debounce</verify>
  <done>UserPicker autocomplete working with debounced search and user selection</done>
</task>

<task type="auto">
  <name>Task 3: Create ShareDialog component</name>
  <files>app/src/components/ShareDialog.tsx</files>
  <action>
Create app/src/components/ShareDialog.tsx - Google Drive-style sharing modal:

**Props:**
```typescript
interface ShareDialogProps {
  folderId: Id<"personalFolders">;
  folderName: string;
  onClose: () => void;
}
```

**Layout (3 sections):**

1. **Header:** "Share [folderName]" title, X close button

2. **Add people section:**
   - UserPicker component
   - Permission dropdown: "Can view" / "Can comment" / "Can edit"
   - "Share" button (disabled until user selected)
   - On share: call folderShares.share mutation, show toast/feedback, clear selection

3. **Current shares section:**
   - "People with access" subheading
   - List current shares (useQuery folderShares.listByFolder)
   - Each share shows: user name/email, permission badge, remove button
   - Owner shown first with "Owner" badge (not removable)

**Permission dropdown options:**
```typescript
const permissionOptions = [
  { value: "view", label: "Can view" },
  { value: "comment", label: "Can comment" },
  { value: "edit", label: "Can edit" },
];
```

**Styling:** Match FolderPicker.tsx modal patterns:
- Fixed overlay with rgba(0,0,0,0.4) background
- Max-width 480px modal
- Sections with border-bottom separators
- var(--color-accent) for primary actions

**State management:**
```typescript
const [selectedUser, setSelectedUser] = useState<User | null>(null);
const [permission, setPermission] = useState<"view" | "comment" | "edit">("view");
const [isSharing, setIsSharing] = useState(false);

const shareMutation = useMutation(api.folderShares.share);
const revokeMutation = useMutation(api.folderShares.revoke);
```
  </action>
  <verify>Component renders, can add/remove shares, modal closes on backdrop click</verify>
  <done>ShareDialog working with user picker, permission selection, and current shares list</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] UserPicker searches users with debounce
- [ ] ShareDialog opens as modal overlay
- [ ] Can search and select user to share with
- [ ] Permission dropdown works
- [ ] Share button creates share
- [ ] Current shares display correctly
- [ ] Remove button revokes share
- [ ] No TypeScript errors
</verification>

<success_criteria>
- All tasks completed
- ShareDialog matches Google Drive UX described in CONTEXT.md
- Styling consistent with existing FolderPicker component
- Share/revoke operations work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/07-folder-sharing/07-02-SUMMARY.md`
</output>
