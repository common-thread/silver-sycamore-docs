---
phase: 09-suggestion-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [app/convex/schema.ts, app/convex/suggestions.ts]
autonomous: true
---

<objective>
Create suggestion schema and API for PR-style document change proposals.

Purpose: Establish data model and backend operations for users to propose changes to official wiki documents, with state machine for workflow progression.
Output: Suggestions table with state management, full CRUD API with state transitions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (versioning and comments patterns):
# - Phase 5 established documentVersions pattern with content snapshots
# - Phase 8 established comments pattern with author enrichment
# These inform the suggestion schema design

@app/convex/schema.ts
@app/convex/documents.ts
@app/convex/versions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create suggestions schema</name>
  <files>app/convex/schema.ts</files>
  <action>
Add suggestions table to schema with fields:
- documentId: v.id("documents") - the official doc being modified
- authorId: v.id("users") - who proposed the change
- status: v.string() - state machine: "draft" | "pending" | "approved" | "rejected"
- title: v.string() - suggested new title (copy of original initially)
- content: v.string() - suggested new content (full document, not diff)
- changeNote: v.string() - description of what changed and why
- reviewedBy: v.optional(v.id("users")) - who approved/rejected
- reviewNote: v.optional(v.string()) - reviewer's feedback
- createdAt: v.number()
- updatedAt: v.number()

Indexes:
- by_document: [documentId] - get all suggestions for a doc
- by_author: [authorId] - user's suggestions
- by_status: [status] - filter by state
- by_document_status: [documentId, status] - pending suggestions for a doc
  </action>
  <verify>npx convex dev --once compiles schema successfully</verify>
  <done>suggestions table defined with all fields and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create suggestions API</name>
  <files>app/convex/suggestions.ts</files>
  <action>
Create new file with queries and mutations:

Queries:
- listByDocument({ documentId }) - all suggestions for a document (newest first)
- listByAuthor({ authorId }) - user's suggestions across all docs (newest first)
- listPending() - all pending suggestions (for reviewers), enriched with author info
- getById({ id }) - single suggestion with author/reviewer info

Mutations:
- create({ documentId, title, content, changeNote }) - creates draft, copies current doc title/content as starting point if not provided, sets authorId from auth
- update({ id, title, content, changeNote }) - update draft only (error if not draft), verify author
- submit({ id }) - transition draft → pending, verify author
- approve({ id, reviewNote }) - transition pending → approved, set reviewedBy from auth, verify reviewer is manager/admin
- reject({ id, reviewNote }) - transition pending → rejected, set reviewedBy from auth, verify reviewer is manager/admin
- delete({ id }) - only drafts can be deleted, verify author

State machine enforced:
- draft: author can edit, submit, delete
- pending: cannot edit, reviewer can approve/reject
- approved/rejected: terminal states (read-only)

Auth patterns: Follow existing permission checks from versions.ts (managers/admins for review actions).
  </action>
  <verify>npx convex dev --once compiles, manual test in Convex dashboard</verify>
  <done>Full CRUD API with state transitions, permission checks enforced</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx convex dev --once` in app/ succeeds
- [ ] suggestions table appears in Convex dashboard
- [ ] Create/update/submit/approve/reject mutations work in dashboard
- [ ] Permission checks prevent unauthorized state transitions
</verification>

<success_criteria>

- Suggestions table created with all fields and indexes
- All CRUD operations work with proper state machine enforcement
- Permission checks: authors own their suggestions, managers/admins review
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-suggestion-workflow/09-01-SUMMARY.md`
</output>
