---
phase: 03-user-profiles
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [app/convex/schema.ts, app/convex/users.ts]
autonomous: true
---

<objective>
Extend user schema with profile fields and role assignment.

Purpose: Store user profile data (name, role, department) alongside auth data.
Output: Updated schema with profile fields, user query/mutation functions.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/02-authentication/02-01-SUMMARY.md
@app/convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update schema with user profile fields</name>
  <files>app/convex/schema.ts</files>
  <action>
The authTables already creates a `users` table. We need to understand that Convex Auth's users table has these fields by default:
- `email` (optional)
- `phone` (optional)
- `name` (optional)
- `image` (optional)
- `emailVerificationTime` (optional)
- `phoneVerificationTime` (optional)
- `isAnonymous` (optional)

We can extend the user data by adding a separate `userProfiles` table that links to the auth user:

```typescript
userProfiles: defineTable({
  userId: v.id("users"),
  displayName: v.optional(v.string()),
  role: v.string(), // "admin" | "manager" | "staff"
  department: v.optional(v.string()),
  avatarUrl: v.optional(v.string()),
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_userId", ["userId"])
  .index("by_role", ["role"]),
```
  </action>
  <verify>Schema updated, convex dev syncs</verify>
  <done>userProfiles table added to schema</done>
</task>

<task type="auto">
  <name>Task 2: Create users.ts with profile functions</name>
  <files>app/convex/users.ts</files>
  <action>
Create `convex/users.ts` with:

1. `getCurrentUser` query - get current authenticated user with profile
2. `getProfile` query - get profile by userId
3. `updateProfile` mutation - update profile fields
4. `setRole` mutation - admin-only role assignment
5. `ensureProfile` mutation - create profile if doesn't exist (called on first login)

Use `ctx.auth.getUserIdentity()` to get current user.
  </action>
  <verify>Functions created and callable</verify>
  <done>users.ts with profile functions</done>
</task>

<task type="auto">
  <name>Task 3: Auto-create profile on auth</name>
  <files>app/convex/auth.ts</files>
  <action>
Update auth.ts to create a default profile when a user signs up.

Use the `callbacks` option in convexAuth to run code after successful authentication:

```typescript
export const { auth, signIn, signOut, store, isAuthenticated } = convexAuth({
  providers: [Password],
  callbacks: {
    async afterUserCreatedOrUpdated(ctx, { userId }) {
      // Check if profile exists, create if not
      const existing = await ctx.db
        .query("userProfiles")
        .withIndex("by_userId", (q) => q.eq("userId", userId))
        .first();

      if (!existing) {
        await ctx.db.insert("userProfiles", {
          userId,
          role: "staff", // Default role
          createdAt: Date.now(),
          updatedAt: Date.now(),
        });
      }
    },
  },
});
```
  </action>
  <verify>New user signup creates profile automatically</verify>
  <done>Auto-profile creation on signup</done>
</task>

<task type="auto">
  <name>Task 4: Sync schema and verify</name>
  <files>app/convex/_generated/*</files>
  <action>
Run convex dev to sync schema and verify:

```bash
cd app && npx convex dev --once
```

Check that userProfiles table is created.
  </action>
  <verify>Schema synced, no errors</verify>
  <done>Schema synced successfully</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] userProfiles table in schema
- [ ] users.ts with profile functions
- [ ] Auto-profile creation on signup
- [ ] Convex dev syncs without errors
</verification>

<success_criteria>
- User profile storage working
- New users get default "staff" role
- Profile queries available for UI
</success_criteria>

<output>
After completion, create `.planning/phases/03-user-profiles/03-01-SUMMARY.md`
</output>
