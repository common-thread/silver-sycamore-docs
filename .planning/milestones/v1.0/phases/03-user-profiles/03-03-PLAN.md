---
phase: 03-user-profiles
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified: [app/src/components/PermissionGuard.tsx, app/src/hooks/usePermissions.ts, app/src/components/UserMenu.tsx]
autonomous: false
---

<objective>
Create UI components and hooks for permission-based rendering.

Purpose: Allow UI to show/hide elements based on user role and permissions.
Output: Permission hooks, guard components, enhanced user menu.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/03-user-profiles/03-02-SUMMARY.md
@app/src/components/UserMenu.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create usePermissions hook</name>
  <files>app/src/hooks/usePermissions.ts</files>
  <action>
Create `src/hooks/usePermissions.ts`:

```typescript
"use client";

import { useQuery } from "convex/react";
import { api } from "../../convex/_generated/api";

export type Role = "admin" | "manager" | "staff";
export type Action = "view_content" | "edit_content" | "delete_content" | "manage_users" | "view_analytics";

const ROLE_PERMISSIONS: Record<Role, Action[]> = {
  staff: ["view_content"],
  manager: ["view_content", "edit_content", "view_analytics"],
  admin: ["view_content", "edit_content", "delete_content", "manage_users", "view_analytics"],
};

export function usePermissions() {
  const currentUser = useQuery(api.users.getCurrentUser);

  const role = (currentUser?.profile?.role as Role) ?? "staff";
  const isLoading = currentUser === undefined;

  const can = (action: Action): boolean => {
    return ROLE_PERMISSIONS[role]?.includes(action) ?? false;
  };

  const hasRole = (requiredRole: Role): boolean => {
    const hierarchy: Role[] = ["staff", "manager", "admin"];
    return hierarchy.indexOf(role) >= hierarchy.indexOf(requiredRole);
  };

  return {
    role,
    isLoading,
    isAdmin: role === "admin",
    isManager: role === "manager" || role === "admin",
    can,
    hasRole,
    user: currentUser,
  };
}
```
  </action>
  <verify>Hook returns role and permission checks</verify>
  <done>usePermissions hook created</done>
</task>

<task type="auto">
  <name>Task 2: Create PermissionGuard component</name>
  <files>app/src/components/PermissionGuard.tsx</files>
  <action>
Create `src/components/PermissionGuard.tsx`:

```typescript
"use client";

import { usePermissions, Action, Role } from "@/hooks/usePermissions";

interface PermissionGuardProps {
  children: React.ReactNode;
  action?: Action;
  role?: Role;
  fallback?: React.ReactNode;
}

export function PermissionGuard({
  children,
  action,
  role,
  fallback = null,
}: PermissionGuardProps) {
  const { can, hasRole, isLoading } = usePermissions();

  if (isLoading) {
    return null; // Or a loading indicator
  }

  if (action && !can(action)) {
    return <>{fallback}</>;
  }

  if (role && !hasRole(role)) {
    return <>{fallback}</>;
  }

  return <>{children}</>;
}

// Convenience components
export function AdminOnly({ children, fallback }: { children: React.ReactNode; fallback?: React.ReactNode }) {
  return <PermissionGuard role="admin" fallback={fallback}>{children}</PermissionGuard>;
}

export function ManagerOnly({ children, fallback }: { children: React.ReactNode; fallback?: React.ReactNode }) {
  return <PermissionGuard role="manager" fallback={fallback}>{children}</PermissionGuard>;
}

export function CanEdit({ children, fallback }: { children: React.ReactNode; fallback?: React.ReactNode }) {
  return <PermissionGuard action="edit_content" fallback={fallback}>{children}</PermissionGuard>;
}
```
  </action>
  <verify>Guard components render conditionally</verify>
  <done>PermissionGuard and convenience components created</done>
</task>

<task type="auto">
  <name>Task 3: Update UserMenu with role display</name>
  <files>app/src/components/UserMenu.tsx</files>
  <action>
Update UserMenu to show user's role badge:

1. Use usePermissions hook
2. Display role badge next to sign out
3. Style role badge using design system
  </action>
  <verify>UserMenu shows role</verify>
  <done>UserMenu displays user role</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>User profiles, roles, and permission system</what-built>
  <how-to-verify>
    1. Run: cd app && bun run dev
    2. Sign up as a new user
    3. Check that user has default "staff" role in header
    4. In Convex dashboard, manually change role to "admin"
    5. Refresh page - should show "admin" badge
    6. Verify PermissionGuard components work (test with AdminOnly)
  </how-to-verify>
  <resume-signal>Type "approved" if Phase 03 is complete, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] usePermissions hook works
- [ ] PermissionGuard renders conditionally
- [ ] UserMenu shows role badge
- [ ] Human verified
</verification>

<success_criteria>
- Role-based UI rendering working
- Permission checks in both server and client
- User role visible in UI
</success_criteria>

<output>
After completion, create `.planning/phases/03-user-profiles/03-03-SUMMARY.md`

Record:
- Permission patterns established
- UI guard usage examples
- Phase 03 completion status
</output>
