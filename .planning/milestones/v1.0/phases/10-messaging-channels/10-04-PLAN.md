---
phase: 10-messaging-channels
plan: 04
type: execute
wave: 3
depends_on: ["10-02", "10-03"]
files_modified: [app/convex/channels.ts, app/src/components/ChannelList.tsx, app/src/components/StartDMDialog.tsx, app/src/components/UserSearchInput.tsx]
autonomous: true
---

<objective>
Add direct messaging between users using DM-type channels.

Purpose: Enable private 1:1 conversations between staff members.
Output: Users can start DMs, see DM list in sidebar, and message directly.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Summaries from prior plans
@.planning/phases/10-messaging-channels/10-01-SUMMARY.md
@.planning/phases/10-messaging-channels/10-02-SUMMARY.md
@.planning/phases/10-messaging-channels/10-03-SUMMARY.md

# Existing components to extend
@app/src/components/ChannelList.tsx
@app/convex/channels.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DM-specific backend functions</name>
  <files>app/convex/channels.ts</files>
  <action>
Add DM-specific functions to channels.ts:

**Query: findOrCreateDM**
- Input: `otherUserId: Id<"users">`
- Logic:
  1. Get current user ID
  2. Search for existing DM channel where both users are members and type="dm"
  3. If found, return channel ID
  4. If not found, create new channel:
     - type: "dm"
     - name: "" (empty, display other user's name in UI)
     - description: null
     - creator: current user
  5. Add both users as members with role="member"
  6. Return new channel ID
- This is idempotent - calling twice returns same channel

**Query: getDMPartner**
- Input: `channelId: Id<"channels">`
- Logic: For a DM channel, return the other member's user profile
- Used by UI to show the other person's name/avatar

**Update listUserChannels:**
- Ensure DM channels include partner info (other user's displayName, avatarUrl)
- DM channels sorted by most recent message (or join date if no messages)
  </action>
  <verify>findOrCreateDM returns consistent channel ID for same user pair</verify>
  <done>DM backend functions working</done>
</task>

<task type="auto">
  <name>Task 2: Create user search and DM dialog</name>
  <files>app/src/components/UserSearchInput.tsx, app/src/components/StartDMDialog.tsx</files>
  <action>
**UserSearchInput.tsx:**
- Reusable component for searching/selecting users
- Props: `onSelect: (userId: Id<"users">) => void`, `excludeUserIds?: Id<"users">[]`
- Features:
  - Input field with search icon
  - Query users with `useQuery(api.users.searchUsers)` (may need to add this query)
  - Show results as list: avatar, displayName, department
  - Click to select
  - Exclude current user from results
  - Debounce search input (300ms)

**StartDMDialog.tsx:**
- Modal dialog for starting new DM
- Contains UserSearchInput
- On user select:
  1. Call findOrCreateDM mutation with selected userId
  2. Navigate to /messages/[channelId]
  3. Close dialog
- Cancel button to close
- Title: "New Direct Message"

**Add users.searchUsers query if needed:**
- Search by displayName (case-insensitive contains)
- Return up to 10 matches
- Exclude current user
  </action>
  <verify>User search shows results, selecting creates/opens DM</verify>
  <done>DM creation flow working</done>
</task>

<task type="auto">
  <name>Task 3: Update ChannelList for DM display</name>
  <files>app/src/components/ChannelList.tsx, app/src/app/messages/[channelId]/page.tsx</files>
  <action>
**ChannelList.tsx updates:**
- "Direct Messages" section shows DM channels
- For each DM:
  - Show other user's avatar (or initial)
  - Show other user's displayName (not channel name)
  - Online indicator placeholder (future feature)
- "+" button in DM section header opens StartDMDialog
- Sort DMs by recent activity

**Channel page updates for DMs:**
- Detect if channel is DM (type === "dm")
- If DM:
  - Header shows other user's name and avatar (not channel name)
  - No "members" count (it's always 2)
  - No settings icon (DMs can't be configured)
- Messaging UI (MessageList, MessageInput) works same for both

**Integration:**
- Wire up StartDMDialog to "+" button and "Start DM" button on /messages page
- Ensure DMs appear in sidebar immediately after creation
  </action>
  <verify>DMs display with user name/avatar, can start new DMs</verify>
  <done>Complete DM experience working</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Can start DM with any user via search
- [ ] DM shows in "Direct Messages" section of sidebar
- [ ] DM displays other user's name, not channel name
- [ ] Same user pair always opens same DM channel
- [ ] Messaging works identically in DMs and regular channels
</verification>

<success_criteria>

- Users can find and message any other staff member directly
- DMs display with the other person's name and avatar
- DM creation is idempotent (clicking same person twice opens same conversation)
- DM list sorted by recent activity
</success_criteria>

<output>
After completion, create `.planning/phases/10-messaging-channels/10-04-SUMMARY.md`
</output>
