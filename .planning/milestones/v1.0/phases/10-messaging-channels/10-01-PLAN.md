---
phase: 10-messaging-channels
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [app/convex/schema.ts, app/convex/channels.ts, app/convex/messages.ts]
autonomous: true
---

<objective>
Create database schema and backend infrastructure for Slack-like messaging system.

Purpose: Establish foundation tables and mutations for channels, membership, and messages that all UI plans will use.
Output: Working channel and message backend with CRUD operations, ready for UI implementation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing patterns to follow
@app/convex/schema.ts
@app/convex/users.ts
@app/convex/comments.ts

# @mention format established in Phase 8: @[userId] storage format
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create channel and membership schemas</name>
  <files>app/convex/schema.ts</files>
  <action>
Add three new tables to schema.ts:

1. **channels** table:
   - `name: v.string()` - channel display name
   - `type: v.string()` - "public" | "private" | "dm" (DMs are 2-person private channels)
   - `description: v.optional(v.string())` - optional channel description
   - `creatorId: v.id("users")` - who created it
   - `isArchived: v.boolean()` - soft delete
   - `createdAt: v.number()`
   - `updatedAt: v.number()`
   - Indexes: `by_type`, `by_creator`

2. **channelMembers** table:
   - `channelId: v.id("channels")`
   - `userId: v.id("users")`
   - `role: v.string()` - "owner" | "admin" | "member"
   - `joinedAt: v.number()`
   - `lastReadAt: v.optional(v.number())` - for unread tracking
   - Indexes: `by_channel`, `by_user`, `by_channel_user` (compound for lookup)

3. **messages** table:
   - `channelId: v.id("channels")`
   - `authorId: v.id("users")`
   - `content: v.string()` - message text with @[userId] mentions
   - `parentId: v.optional(v.id("messages"))` - for threaded replies
   - `fileId: v.optional(v.id("files"))` - optional file attachment
   - `isEdited: v.boolean()`
   - `createdAt: v.number()`
   - `updatedAt: v.number()`
   - Indexes: `by_channel`, `by_author`, `by_parent`, `by_channel_created` (for pagination)
  </action>
  <verify>npx convex dev --once syncs without errors</verify>
  <done>Three new tables in schema with proper indexes</done>
</task>

<task type="auto">
  <name>Task 2: Create channel mutations and queries</name>
  <files>app/convex/channels.ts</files>
  <action>
Create new convex/channels.ts with:

**Queries:**
- `listUserChannels` - Get all channels where user is a member (returns channel + membership info)
- `getChannel` - Get single channel by ID (only if user is member)
- `getChannelMembers` - Get all members of a channel with their profiles
- `findDMChannel` - Find existing DM channel between two users (for DM creation)

**Mutations:**
- `createChannel` - Create public/private channel, add creator as owner
- `updateChannel` - Update name/description (owner/admin only)
- `archiveChannel` - Soft delete (owner only)
- `joinChannel` - Add current user to public channel
- `leaveChannel` - Remove current user from channel (can't leave if owner)
- `addMember` - Add user to channel (owner/admin only for private)
- `removeMember` - Remove user from channel (owner/admin only)
- `updateLastRead` - Mark channel as read (update lastReadAt)

**Permission logic:**
- Public channels: anyone can join
- Private channels: invite-only (addMember by owner/admin)
- DM channels: created via separate flow in Plan 04
- All queries verify membership before returning data
  </action>
  <verify>npx convex dev --once syncs, functions exported</verify>
  <done>Channel CRUD with membership management working</done>
</task>

<task type="auto">
  <name>Task 3: Create message mutations and queries</name>
  <files>app/convex/messages.ts</files>
  <action>
Create new convex/messages.ts with:

**Queries:**
- `listMessages` - Get messages for a channel (paginated, newest first, verify membership)
- `getMessage` - Get single message by ID
- `getThreadMessages` - Get replies to a parent message
- `getUnreadCount` - Count messages in channel since user's lastReadAt

**Mutations:**
- `sendMessage` - Create message in channel (verify membership)
  - Content can contain @[userId] mentions (same format as comments)
  - Optional parentId for thread replies
  - Optional fileId for attachments
- `editMessage` - Update message content (author only, set isEdited=true)
- `deleteMessage` - Soft delete or hard delete (author or channel admin)

**Real-time pattern:** These queries use standard Convex patterns - useQuery subscribers automatically get updates when messages are created/edited.

**Pagination:** listMessages should accept `limit` and `cursor` (message ID) params for infinite scroll.
  </action>
  <verify>npx convex dev --once syncs, functions exported</verify>
  <done>Message CRUD with threading support working</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx convex dev --once` syncs without errors
- [ ] channels, channelMembers, messages tables exist in schema
- [ ] convex/channels.ts exports all queries and mutations
- [ ] convex/messages.ts exports all queries and mutations
- [ ] TypeScript types generated in _generated/api.d.ts
</verification>

<success_criteria>

- Schema deployed with all three tables
- Channel creation and membership mutations work
- Message send/edit/delete mutations work
- Queries properly check membership before returning data
- Ready for UI implementation in Plans 02 and 03
</success_criteria>

<output>
After completion, create `.planning/phases/10-messaging-channels/10-01-SUMMARY.md`
</output>
