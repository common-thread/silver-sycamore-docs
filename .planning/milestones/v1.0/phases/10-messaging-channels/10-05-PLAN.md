---
phase: 10-messaging-channels
plan: 05
type: execute
wave: 3
depends_on: ["10-03"]
files_modified: [app/convex/messages.ts, app/src/components/MessageInput.tsx, app/src/components/MessageItem.tsx, app/src/components/FileAttachment.tsx]
autonomous: true
---

<objective>
Add file sharing capability to channel messages.

Purpose: Allow users to share files (images, documents, etc.) in conversations.
Output: File attachment button in message input, file preview in messages.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan summaries
@.planning/phases/10-messaging-channels/10-01-SUMMARY.md
@.planning/phases/10-messaging-channels/10-03-SUMMARY.md

# Existing file upload patterns
@app/convex/schema.ts
@app/convex/files.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update message backend for file attachments</name>
  <files>app/convex/messages.ts</files>
  <action>
Update messages.ts to support file attachments:

**Modify sendMessage mutation:**
- Add optional `storageId: Id<"_storage">` parameter
- If storageId provided:
  1. Create file record in files table (name, mimeType, size from storage metadata)
  2. Set fileId on message
- Message can have both content and file, or just file

**Add uploadUrl generation:**
- `generateUploadUrl` mutation - returns Convex upload URL
- Standard Convex file upload pattern

**Add getFileUrl query:**
- Input: `fileId: Id<"files">`
- Returns: URL to download/view file via `ctx.storage.getUrl()`

**Note:** Schema already has `fileId: v.optional(v.id("files"))` on messages table from Plan 01.
  </action>
  <verify>Can send message with file attachment via API</verify>
  <done>File attachment backend working</done>
</task>

<task type="auto">
  <name>Task 2: Add file picker to MessageInput</name>
  <files>app/src/components/MessageInput.tsx</files>
  <action>
Update MessageInput to support file uploads:

**UI changes:**
- Add paperclip/attachment icon button before send button
- Hidden file input element
- Click attachment button triggers file input click
- Show selected file preview before sending:
  - File name
  - File size (formatted: "2.4 MB")
  - Remove button (X) to cancel
- Disable send button while uploading

**Upload flow:**
1. User clicks attachment button
2. File picker opens
3. User selects file
4. Get upload URL from `generateUploadUrl` mutation
5. Upload file to Convex storage
6. Show loading indicator during upload
7. On success, store storageId in component state
8. User can add message text (optional)
9. On send, include storageId in sendMessage call
10. Clear file state after send

**File types:** Accept common types (images, PDFs, docs, spreadsheets)
- accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt"

**Size limit:** Show error if file > 10MB (Convex limit)
  </action>
  <verify>Can select file, see preview, send with message</verify>
  <done>File picker UI working</done>
</task>

<task type="auto">
  <name>Task 3: Create FileAttachment display component</name>
  <files>app/src/components/FileAttachment.tsx, app/src/components/MessageItem.tsx</files>
  <action>
**FileAttachment.tsx:**
- Props: `file: { name, mimeType, size, url }`
- Display based on file type:
  - **Images:** Inline preview (max-width 300px, click to expand/open)
  - **PDFs:** PDF icon + filename + "View" link
  - **Other files:** Generic file icon + filename + "Download" link
- Show file size in human-readable format
- Click behavior:
  - Images: open in new tab (or lightbox if feeling fancy)
  - Other: download

**MessageItem.tsx updates:**
- Check if message has fileId
- If yes, query file details and URL
- Render FileAttachment component below message content
- File appears after text content (if any)

**Styling:**
- Image previews: rounded corners, border
- File attachments: card-style with icon, name, size
- Download icon on hover
  </action>
  <verify>Messages with files show proper previews, images display inline</verify>
  <done>File display in messages working</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Attachment button in message input
- [ ] Can upload files up to 10MB
- [ ] File preview shown before sending
- [ ] Images display inline in messages
- [ ] Other files show as downloadable links
- [ ] Messages can have text + file or just file
</verification>

<success_criteria>

- Users can attach files to messages
- Images display as inline previews
- Documents/files show download links
- Upload progress indicated
- Works in both channels and DMs
</success_criteria>

<output>
After completion, create `.planning/phases/10-messaging-channels/10-05-SUMMARY.md`
</output>
