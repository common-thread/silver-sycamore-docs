---
phase: 05-document-versioning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [app/convex/schema.ts, app/convex/versions.ts, app/convex/documents.ts]
autonomous: true
---

<objective>
Create version storage schema and backend functions for document history.

Purpose: Track all document changes with ability to view and restore previous versions.
Output: documentVersions table, version creation on save, version queries.
</objective>

<context>
@.planning/PROJECT.md
@app/convex/schema.ts
@app/convex/documents.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add documentVersions table to schema</name>
  <files>app/convex/schema.ts</files>
  <action>
Add documentVersions table:

```typescript
documentVersions: defineTable({
  documentId: v.id("documents"),
  version: v.number(),
  title: v.string(),
  content: v.string(),
  category: v.string(),
  subcategory: v.optional(v.string()),
  editedBy: v.optional(v.id("users")),
  editedByName: v.optional(v.string()),
  changeNote: v.optional(v.string()),
  createdAt: v.number(),
})
  .index("by_document", ["documentId"])
  .index("by_document_version", ["documentId", "version"]),
```
  </action>
  <verify>Schema syncs with new table</verify>
  <done>documentVersions table added</done>
</task>

<task type="auto">
  <name>Task 2: Create versions.ts with queries</name>
  <files>app/convex/versions.ts</files>
  <action>
Create `convex/versions.ts`:

1. `listByDocument` - Get all versions for a document (newest first)
2. `getVersion` - Get specific version by documentId and version number
3. `getLatestVersion` - Get most recent version number
4. `createVersion` - Internal: create new version snapshot
  </action>
  <verify>Version queries work</verify>
  <done>versions.ts created</done>
</task>

<task type="auto">
  <name>Task 3: Update documents.ts to create versions on update</name>
  <files>app/convex/documents.ts</files>
  <action>
Modify the `update` mutation to:

1. Before updating, snapshot current state as new version
2. Use internal mutation to create version
3. Increment version counter
4. Include optional changeNote in update args
5. Track who made the edit (from auth)
  </action>
  <verify>Updating document creates version</verify>
  <done>Auto-versioning on update</done>
</task>

<task type="auto">
  <name>Task 4: Sync and verify</name>
  <files>app/convex/_generated/*</files>
  <action>
Run convex dev to sync schema and verify version creation works.
  </action>
  <verify>Schema synced, versions created on update</verify>
  <done>Version system operational</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] documentVersions table in schema
- [ ] versions.ts with queries
- [ ] Document update creates version
- [ ] Convex dev syncs
</verification>

<success_criteria>
- Every document edit is tracked as a version
- Versions can be queried by document
- Version history preserved indefinitely
</success_criteria>

<output>
After completion, create `.planning/phases/05-document-versioning/05-01-SUMMARY.md`
</output>
