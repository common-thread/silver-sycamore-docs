---
phase: 05-document-versioning
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified: [app/src/components/VersionCompare.tsx, app/convex/versions.ts, app/src/app/[category]/[slug]/versions/[version]/page.tsx]
autonomous: false
---

<objective>
Build version comparison view and restore functionality.

Purpose: Allow viewing old versions and restoring if needed.
Output: Version diff view, restore mutation, version detail page.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/05-document-versioning/05-02-SUMMARY.md
@app/convex/versions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add restore mutation</name>
  <files>app/convex/versions.ts</files>
  <action>
Add `restoreVersion` mutation:

```typescript
export const restoreVersion = mutation({
  args: {
    documentId: v.id("documents"),
    version: v.number(),
  },
  handler: async (ctx, args) => {
    // Check permission (manager or admin)
    // Get the version to restore
    // Snapshot current as new version
    // Update document with old version's content
    // Return success
  },
});
```
  </action>
  <verify>Restore mutation works</verify>
  <done>Restore functionality added</done>
</task>

<task type="auto">
  <name>Task 2: Create VersionCompare component</name>
  <files>app/src/components/VersionCompare.tsx</files>
  <action>
Create `src/components/VersionCompare.tsx`:

- Takes documentId and version number as props
- Fetches specific version content
- Side-by-side or inline diff view
- Highlight additions (green) and deletions (red)
- Use simple text diff (no complex library needed)
- "Restore this version" button (permission-gated)
  </action>
  <verify>VersionCompare shows diff</verify>
  <done>Comparison view created</done>
</task>

<task type="auto">
  <name>Task 3: Create version detail page</name>
  <files>app/src/app/[category]/[slug]/versions/[version]/page.tsx</files>
  <action>
Create page at `/[category]/[slug]/versions/[version]`:

- Shows specific version content
- Breadcrumb: Home > Category > Document > Version X
- "View Current" link back to main document
- "Restore" button if user has permission
- Uses VersionCompare for diff view option
  </action>
  <verify>Version page renders correctly</verify>
  <done>Version detail page created</done>
</task>

<task type="auto">
  <name>Task 4: Link versions in VersionHistory</name>
  <files>app/src/components/VersionHistory.tsx</files>
  <action>
Update VersionHistory to:

1. Link each version to its detail page
2. Add "Compare" button to show diff inline
3. Style active/selected version
  </action>
  <verify>Versions are clickable</verify>
  <done>Version navigation working</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Document versioning with history, comparison, and restore</what-built>
  <how-to-verify>
    1. Run: cd app && bun run dev
    2. Navigate to any document
    3. Check version badge shows (may be v0 if no edits)
    4. Edit document content (if edit UI exists)
    5. Verify version increments
    6. View version history
    7. Click old version to see comparison
    8. Test restore (if manager/admin)
  </how-to-verify>
  <resume-signal>Type "approved" if Phase 05 is complete, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Restore mutation works
- [ ] VersionCompare shows changes
- [ ] Version detail page works
- [ ] History links to versions
- [ ] Human verified
</verification>

<success_criteria>
- Users can view any historical version
- Diff shows what changed
- Managers/admins can restore old versions
- All changes are tracked
</success_criteria>

<output>
After completion, create `.planning/phases/05-document-versioning/05-03-SUMMARY.md`

Record:
- Versioning patterns established
- Permission requirements for restore
- Phase 05 completion status
</output>
