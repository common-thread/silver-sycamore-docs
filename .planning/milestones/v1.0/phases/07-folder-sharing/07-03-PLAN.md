---
phase: 07-folder-sharing
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified: [app/src/app/workspace/shared/page.tsx, app/src/app/workspace/layout.tsx, app/src/components/FolderTree.tsx, app/convex/personalFolders.ts, app/convex/personalDocuments.ts]
autonomous: true
---

<objective>
Create "Shared with me" view and integrate sharing access control throughout workspace.

Purpose: Let users find and access folders shared with them, with proper permission enforcement.
Output: Shared folders section in workspace, access control in folder/document queries.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-folder-sharing/07-CONTEXT.md
@.planning/phases/07-folder-sharing/07-01-SUMMARY.md

@app/src/app/workspace/layout.tsx
@app/src/app/workspace/page.tsx
@app/src/components/FolderTree.tsx
@app/convex/personalFolders.ts
@app/convex/personalDocuments.ts
@app/convex/folderShares.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add access control to folder/document queries</name>
  <files>app/convex/personalFolders.ts, app/convex/personalDocuments.ts</files>
  <action>
Update both files to allow access when user has share permission:

**personalFolders.ts - Update `get` query:**
```typescript
export const get = query({
  args: { id: v.id("personalFolders") },
  handler: async (ctx, args) => {
    const userId = await getCurrentUserId(ctx);
    if (!userId) return null;

    const folder = await ctx.db.get(args.id);
    if (!folder) return null;

    // Owner has full access
    if (folder.ownerId === userId) return folder;

    // Check for share access
    const directShare = await ctx.db
      .query("folderShares")
      .withIndex("by_folder_user", (q) =>
        q.eq("folderId", args.id).eq("sharedWithUserId", userId)
      )
      .first();

    if (directShare) return { ...folder, _permission: directShare.permission };

    // Check group shares
    const userGroups = await ctx.db
      .query("groupMembers")
      .withIndex("by_user", (q) => q.eq("userId", userId))
      .collect();

    for (const membership of userGroups) {
      const groupShare = await ctx.db
        .query("folderShares")
        .withIndex("by_folder_group", (q) =>
          q.eq("folderId", args.id).eq("sharedWithGroupId", membership.groupId)
        )
        .first();
      if (groupShare) return { ...folder, _permission: groupShare.permission };
    }

    return null; // No access
  },
});
```

**personalDocuments.ts - Update `list` and `get` queries:**
For `list` - when folderId is provided, check if user owns the folder OR has share access to it.

For `get` - check if user owns the document OR has share access to the folder it's in.

**Add helper function** (can be in either file or a shared utils):
```typescript
async function hasShareAccess(
  ctx: any,
  folderId: Id<"personalFolders">,
  userId: Id<"users">
): Promise<{ hasAccess: boolean; permission: string | null }> {
  // Direct share
  const directShare = await ctx.db
    .query("folderShares")
    .withIndex("by_folder_user", (q) =>
      q.eq("folderId", folderId).eq("sharedWithUserId", userId)
    )
    .first();

  if (directShare) {
    return { hasAccess: true, permission: directShare.permission };
  }

  // Group shares
  const userGroups = await ctx.db
    .query("groupMembers")
    .withIndex("by_user", (q) => q.eq("userId", userId))
    .collect();

  for (const membership of userGroups) {
    const groupShare = await ctx.db
      .query("folderShares")
      .withIndex("by_folder_group", (q) =>
        q.eq("folderId", folderId).eq("sharedWithGroupId", membership.groupId)
      )
      .first();
    if (groupShare) {
      return { hasAccess: true, permission: groupShare.permission };
    }
  }

  return { hasAccess: false, permission: null };
}
```
  </action>
  <verify>TypeScript compiles, shared folders accessible via get query</verify>
  <done>Access control allows shared folder/document access with permission tracking</done>
</task>

<task type="auto">
  <name>Task 2: Create Shared with me page</name>
  <files>app/src/app/workspace/shared/page.tsx</files>
  <action>
Create app/src/app/workspace/shared/page.tsx - displays folders shared with current user:

**Layout:**
1. Page title: "Shared with me"
2. List of shared folders with:
   - Folder name
   - "Shared by [owner name]" subtitle
   - Permission badge (View/Comment/Edit)
   - Click navigates to /workspace?folder={id}&shared=true

**Implementation:**
```typescript
"use client";

import { useQuery } from "convex/react";
import { api } from "../../../convex/_generated/api";
import Link from "next/link";

export default function SharedWithMePage() {
  const sharedFolders = useQuery(api.folderShares.listSharedWithMe);

  return (
    <div style={{ padding: "2rem" }}>
      <h1 style={{
        fontFamily: "var(--font-display)",
        fontSize: "1.5rem",
        fontWeight: 600,
        marginBottom: "1.5rem",
      }}>
        Shared with me
      </h1>

      {sharedFolders?.length === 0 && (
        <p style={{
          color: "var(--color-ink-muted)",
          fontFamily: "var(--font-body)",
        }}>
          No folders have been shared with you yet.
        </p>
      )}

      <div style={{ display: "flex", flexDirection: "column", gap: "0.75rem" }}>
        {sharedFolders?.map((item) => (
          <Link
            key={item.folder._id}
            href={`/workspace?folder=${item.folder._id}&shared=true`}
            style={{
              display: "block",
              padding: "1rem",
              border: "1px solid var(--color-border)",
              borderRadius: "2px",
              textDecoration: "none",
            }}
          >
            <div style={{
              fontFamily: "var(--font-body)",
              fontWeight: 500,
              color: "var(--color-ink)",
            }}>
              {item.folder.name}
            </div>
            <div style={{
              fontSize: "0.8125rem",
              color: "var(--color-ink-muted)",
              marginTop: "0.25rem",
            }}>
              Shared by {item.sharedBy.displayName || item.sharedBy.name || item.sharedBy.email}
              <span style={{
                marginLeft: "0.5rem",
                padding: "0.125rem 0.375rem",
                background: "var(--color-background)",
                borderRadius: "2px",
                fontSize: "0.75rem",
              }}>
                {item.permission === "edit" ? "Can edit" :
                 item.permission === "comment" ? "Can comment" : "Can view"}
              </span>
            </div>
          </Link>
        ))}
      </div>
    </div>
  );
}
```
  </action>
  <verify>Page renders at /workspace/shared, shows shared folders</verify>
  <done>Shared with me page lists folders shared with current user</done>
</task>

<task type="auto">
  <name>Task 3: Add sharing UI to workspace sidebar</name>
  <files>app/src/app/workspace/layout.tsx, app/src/components/FolderTree.tsx</files>
  <action>
**Update FolderTree.tsx:**
1. Add share button next to each folder (visible on hover or always for owned folders)
2. On click, open ShareDialog for that folder
3. Import and use ShareDialog component

```typescript
// Add to FolderTree.tsx
import { ShareDialog } from "./ShareDialog";

// State for share dialog
const [sharingFolder, setSharingFolder] = useState<{id: Id<"personalFolders">, name: string} | null>(null);

// In folder render, add share button:
<button
  onClick={(e) => {
    e.stopPropagation();
    setSharingFolder({ id: folder._id, name: folder.name });
  }}
  title="Share folder"
  style={{ /* subtle icon button styles */ }}
>
  <ShareIcon />
</button>

// Render dialog when folder selected:
{sharingFolder && (
  <ShareDialog
    folderId={sharingFolder.id}
    folderName={sharingFolder.name}
    onClose={() => setSharingFolder(null)}
  />
)}
```

**Update layout.tsx sidebar:**
Add "Shared with me" link in sidebar below folder tree:

```typescript
<Link
  href="/workspace/shared"
  style={{
    display: "flex",
    alignItems: "center",
    gap: "0.5rem",
    padding: "0.5rem",
    marginTop: "1rem",
    color: "var(--color-ink-light)",
    textDecoration: "none",
    fontSize: "0.8125rem",
    borderTop: "1px solid var(--color-border)",
    paddingTop: "1rem",
  }}
>
  <UsersIcon /> {/* People/share icon */}
  Shared with me
</Link>
```

Add shared folder count badge if available.
  </action>
  <verify>Share button appears on folders, ShareDialog opens, "Shared with me" link works</verify>
  <done>Workspace UI integrated with sharing - share buttons and shared section link</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] /workspace/shared page renders shared folders
- [ ] Clicking shared folder navigates to folder view
- [ ] Share button on folders opens ShareDialog
- [ ] Access control allows viewing shared folder contents
- [ ] "Shared with me" link appears in sidebar
- [ ] No TypeScript errors
</verification>

<success_criteria>
- All tasks completed
- Users can find shared folders in dedicated section
- Share button provides quick access to sharing modal
- Permission badges show access level
- Access control properly enforced
</success_criteria>

<output>
After completion, create `.planning/phases/07-folder-sharing/07-03-SUMMARY.md`
</output>
