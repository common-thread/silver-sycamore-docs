---
phase: 07-folder-sharing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [app/convex/schema.ts, app/convex/folderShares.ts, app/convex/shareGroups.ts]
autonomous: true
---

<objective>
Create sharing schema and backend API for folder sharing functionality.

Purpose: Enable users to share personal folders with individuals or groups at different permission levels (View, Comment, Edit).
Output: Database tables and Convex API for managing shares, groups, and access control.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-folder-sharing/07-CONTEXT.md
@.planning/phases/06-personal-workspace/06-01-SUMMARY.md

@app/convex/schema.ts
@app/convex/personalFolders.ts
@app/convex/users.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sharing tables to schema</name>
  <files>app/convex/schema.ts</files>
  <action>
Add three new tables to schema.ts:

1. **folderShares** - Individual share grants:
```typescript
folderShares: defineTable({
  folderId: v.id("personalFolders"),
  sharedWithUserId: v.optional(v.id("users")),     // Direct user share
  sharedWithGroupId: v.optional(v.id("shareGroups")), // Group share
  permission: v.string(), // "view" | "comment" | "edit"
  sharedBy: v.id("users"),
  createdAt: v.number(),
})
  .index("by_folder", ["folderId"])
  .index("by_user", ["sharedWithUserId"])
  .index("by_group", ["sharedWithGroupId"])
  .index("by_folder_user", ["folderId", "sharedWithUserId"])
  .index("by_folder_group", ["folderId", "sharedWithGroupId"]),
```

2. **shareGroups** - Ad-hoc groups for sharing:
```typescript
shareGroups: defineTable({
  name: v.string(),
  ownerId: v.id("users"),
  createdAt: v.number(),
})
  .index("by_owner", ["ownerId"]),
```

3. **groupMembers** - User membership in groups:
```typescript
groupMembers: defineTable({
  groupId: v.id("shareGroups"),
  userId: v.id("users"),
  addedAt: v.number(),
})
  .index("by_group", ["groupId"])
  .index("by_user", ["userId"])
  .index("by_group_user", ["groupId", "userId"]),
```

Permission levels are strings to allow future expansion. Current values: "view", "comment", "edit".
  </action>
  <verify>npx convex dev --once (schema sync succeeds)</verify>
  <done>Three new tables added with proper indexes for efficient querying</done>
</task>

<task type="auto">
  <name>Task 2: Create folderShares API</name>
  <files>app/convex/folderShares.ts</files>
  <action>
Create app/convex/folderShares.ts with:

**Queries:**
- `listByFolder` - Get all shares for a folder (owner only)
- `listSharedWithMe` - Get folders shared with current user (via direct share or group membership)
- `getPermission` - Check user's permission level for a folder (returns "view"|"comment"|"edit"|null)
- `canAccess` - Boolean check if user can access folder at any level

**Mutations:**
- `share` - Create share (owner only). Args: folderId, userId OR groupId, permission. Validate:
  - Folder exists and user owns it
  - Target user/group exists
  - No duplicate share (upsert permission if exists)
- `updatePermission` - Change permission level for existing share
- `revoke` - Remove share access

**Helper function:** `getCurrentUserId(ctx)` - Reuse pattern from personalFolders.ts

**Access validation pattern:**
```typescript
// Check ownership
const folder = await ctx.db.get(args.folderId);
if (!folder || folder.ownerId !== userId) {
  throw new Error("Folder not found or access denied");
}
```

For `listSharedWithMe`:
1. Get direct shares where sharedWithUserId = current user
2. Get user's group memberships
3. Get group shares for those groups
4. Combine and dedupe, joining folder data
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>Complete folderShares API with share, revoke, and access check functions</done>
</task>

<task type="auto">
  <name>Task 3: Create shareGroups API</name>
  <files>app/convex/shareGroups.ts</files>
  <action>
Create app/convex/shareGroups.ts with:

**Queries:**
- `listMyGroups` - Groups current user owns
- `listMyMemberships` - Groups current user is a member of
- `get` - Get single group with members
- `getMembers` - Get all members of a group with user info

**Mutations:**
- `create` - Create new group (any user can create groups)
- `rename` - Rename group (owner only)
- `delete` - Delete group (owner only, cascades: removes all groupMembers, removes all folderShares referencing this group)
- `addMember` - Add user to group (owner only)
- `removeMember` - Remove user from group (owner only)

**Cascade delete pattern:**
```typescript
// When deleting group, first remove related records
const shares = await ctx.db
  .query("folderShares")
  .withIndex("by_group", (q) => q.eq("sharedWithGroupId", args.id))
  .collect();
for (const share of shares) {
  await ctx.db.delete(share._id);
}

const members = await ctx.db
  .query("groupMembers")
  .withIndex("by_group", (q) => q.eq("groupId", args.id))
  .collect();
for (const member of members) {
  await ctx.db.delete(member._id);
}

await ctx.db.delete(args.id);
```
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>Complete shareGroups API with create, manage members, and cascade delete</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx convex dev --once` succeeds (schema syncs)
- [ ] No TypeScript errors in convex files
- [ ] All three new tables have proper indexes
- [ ] folderShares.ts exports all planned queries and mutations
- [ ] shareGroups.ts exports all planned queries and mutations
</verification>

<success_criteria>
- All tasks completed
- Schema includes folderShares, shareGroups, groupMembers tables
- APIs handle owner validation and access control
- Cascade delete prevents orphaned records
</success_criteria>

<output>
After completion, create `.planning/phases/07-folder-sharing/07-01-SUMMARY.md`
</output>
