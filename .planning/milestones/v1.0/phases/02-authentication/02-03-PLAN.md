---
phase: 02-authentication
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified: [app/src/middleware.ts, app/src/app/layout.tsx]
autonomous: true
---

<objective>
Implement route protection with Next.js middleware and session management.

Purpose: Protect all app routes requiring authentication, redirect unauthenticated users to sign-in.
Output: Middleware configuration, protected routes, session cookie settings.
</objective>

<context>
@.planning/PROJECT.md
@.planning/phases/02-authentication/RESEARCH.md
@.planning/phases/02-authentication/02-02-SUMMARY.md
@app/src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create middleware.ts for route protection</name>
  <files>app/src/middleware.ts</files>
  <action>
Create `src/middleware.ts`:

```typescript
import {
  convexAuthNextjsMiddleware,
  createRouteMatcher,
  nextjsMiddlewareRedirect,
} from "@convex-dev/auth/nextjs/server";

// Public routes that don't require auth
const isPublicRoute = createRouteMatcher(["/signin"]);

// All other routes require auth
const isProtectedRoute = createRouteMatcher([
  "/",
  "/services(.*)",
  "/clients(.*)",
  "/staff(.*)",
  "/operations(.*)",
  "/deliverables(.*)",
  "/catalog(.*)",
  "/components(.*)",
]);

export default convexAuthNextjsMiddleware(
  async (request, { convexAuth }) => {
    const authenticated = await convexAuth.isAuthenticated();

    // Redirect signed-in users away from signin page
    if (isPublicRoute(request) && authenticated) {
      return nextjsMiddlewareRedirect(request, "/");
    }

    // Redirect unauthenticated users to signin
    if (isProtectedRoute(request) && !authenticated) {
      return nextjsMiddlewareRedirect(request, "/signin");
    }
  },
  {
    // 30-day session for convenience
    cookieConfig: { maxAge: 60 * 60 * 24 * 30 },
  }
);

export const config = {
  matcher: ["/((?!.*\\..*|_next).*)", "/", "/(api|trpc)(.*)"],
};
```
  </action>
  <verify>Middleware file created with correct patterns</verify>
  <done>middleware.ts created with route protection</done>
</task>

<task type="auto">
  <name>Task 2: Update layout.tsx with server provider</name>
  <files>app/src/app/layout.tsx</files>
  <action>
Update layout.tsx to use ConvexAuthNextjsServerProvider:

1. Import from @convex-dev/auth/nextjs/server
2. Wrap the body content with the server provider
3. Keep existing ConvexClientProvider inside

Structure:
```tsx
<ConvexAuthNextjsServerProvider>
  <ConvexClientProvider>
    {/* existing layout */}
  </ConvexClientProvider>
</ConvexAuthNextjsServerProvider>
```
  </action>
  <verify>Layout renders with both providers</verify>
  <done>Layout uses server auth provider</done>
</task>

<task type="auto">
  <name>Task 3: Test route protection</name>
  <files>None</files>
  <action>
Test the complete auth flow:

1. Clear browser cookies/storage
2. Navigate to http://localhost:3001/
3. Should redirect to /signin
4. Sign in with test credentials
5. Should redirect to /
6. Navigate to various routes - should work
7. Sign out
8. Should redirect to /signin
9. Try to access protected route - should redirect to /signin
  </action>
  <verify>All redirects work correctly</verify>
  <done>Route protection verified</done>
</task>

<task type="auto">
  <name>Task 4: Verify server-side auth access</name>
  <files>None</files>
  <action>
Verify server components can access auth state:

1. Check that protected pages load correctly
2. Verify no hydration errors
3. Check that Convex queries work with auth context

If issues, may need to add `convexAuthNextjsToken()` to server component queries.
  </action>
  <verify>Server components work with auth</verify>
  <done>Server-side auth verified</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete authentication system with route protection</what-built>
  <how-to-verify>
    1. Clear cookies/local storage in browser
    2. Navigate to http://localhost:3001/
    3. Should redirect to /signin
    4. Sign up with new test account
    5. After sign up, should redirect to home
    6. Header should show user email and sign out
    7. Navigate to all main sections (Services, Clients, Staff, etc.)
    8. Sign out - should redirect to /signin
    9. Try to access /services directly - should redirect to /signin
    10. Sign back in - should work

    **Success criteria:**
    - Unauthenticated users always see signin
    - Authenticated users can access all routes
    - Sign out works and clears session
    - No console errors
  </how-to-verify>
  <resume-signal>Type "approved" if Phase 02 is complete, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] middleware.ts exists with route matchers
- [ ] Layout uses server auth provider
- [ ] Protected routes redirect to /signin
- [ ] Signin redirects to / after auth
- [ ] Sign out clears session
- [ ] No hydration errors
- [ ] Human verified complete flow
</verification>

<success_criteria>
- All routes protected except /signin
- Session persists across page reloads
- Sign out works correctly
- Complete auth flow verified by human
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-03-SUMMARY.md`

Record:
- Route protection patterns
- Any middleware adjustments
- Phase 02 completion status
- Auth patterns established for future phases
</output>
