---
phase: 20-dynamic-content-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [app/convex/schema.ts]
autonomous: true
---

<objective>
Add schema foundation for dynamic content system — tables for tracking instances, activity logs, and share links.

Purpose: All subsequent Phase 20 plans depend on these tables existing. This is the foundation that enables completion tracking, activity feeds, and shareable links.
Output: Three new Convex tables with proper indexes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-dynamic-content-system/20-RESEARCH.md

@app/convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dynamicContentInstances table</name>
  <files>app/convex/schema.ts</files>
  <action>
Add the `dynamicContentInstances` table to track personal instances of procedures, checklists, and forms.

Schema definition:
```typescript
dynamicContentInstances: defineTable({
  // Source template
  sourceDocumentId: v.id("documents"),
  sourceType: v.union(
    v.literal("procedure"),
    v.literal("checklist"),
    v.literal("form")
  ),

  // Owner (null for anonymous)
  userId: v.optional(v.id("users")),
  sessionId: v.optional(v.string()), // For anonymous users

  // Completion state
  status: v.union(
    v.literal("in_progress"),
    v.literal("completed"),
    v.literal("submitted")
  ),
  completionData: v.string(), // JSON: step states, form values
  completedSteps: v.optional(v.number()), // Quick access to progress
  totalSteps: v.optional(v.number()),

  // Metadata
  startedAt: v.number(),
  completedAt: v.optional(v.number()),
  submittedTo: v.optional(v.array(v.id("users"))), // Who receives results
})
  .index("by_source", ["sourceDocumentId"])
  .index("by_user", ["userId"])
  .index("by_user_source", ["userId", "sourceDocumentId"])
  .index("by_session", ["sessionId"])
  .index("by_user_status", ["userId", "status"]),
```

Place this after the existing `notifications` table definition.
  </action>
  <verify>npx convex dev --once (should deploy schema successfully)</verify>
  <done>dynamicContentInstances table exists with all indexes</done>
</task>

<task type="auto">
  <name>Task 2: Add activityLog and shareLinks tables</name>
  <files>app/convex/schema.ts</files>
  <action>
Add two more tables after `dynamicContentInstances`:

**activityLog table** — tracks user activity for dashboard and sidebar:
```typescript
activityLog: defineTable({
  userId: v.id("users"),

  // What happened
  type: v.union(
    v.literal("procedure_started"),
    v.literal("procedure_completed"),
    v.literal("checklist_completed"),
    v.literal("form_submitted"),
    v.literal("form_received") // Someone submitted to this user
  ),

  // References
  instanceId: v.optional(v.id("dynamicContentInstances")),
  documentId: v.optional(v.id("documents")),
  formSubmissionId: v.optional(v.id("formSubmissions")),

  // Context
  title: v.string(), // Denormalized for display
  fromUserId: v.optional(v.id("users")), // Who triggered (for received items)

  // Timestamps
  createdAt: v.number(),
})
  .index("by_user", ["userId"])
  .index("by_user_recent", ["userId", "createdAt"])
  .index("by_type", ["type"]),
```

**shareLinks table** — enables internal and external sharing:
```typescript
shareLinks: defineTable({
  // What's being shared
  documentId: v.id("documents"),

  // Link configuration
  shareToken: v.string(), // Random token for URL
  shareType: v.union(v.literal("internal"), v.literal("external")),

  // Access control
  createdBy: v.id("users"),
  sharedWithUserIds: v.optional(v.array(v.id("users"))), // Internal shares
  routeResultsTo: v.array(v.id("users")), // Who gets submissions

  // Expiration (optional)
  expiresAt: v.optional(v.number()),
  maxUses: v.optional(v.number()),
  useCount: v.number(),

  // Metadata
  createdAt: v.number(),
})
  .index("by_token", ["shareToken"])
  .index("by_document", ["documentId"])
  .index("by_creator", ["createdBy"]),
```
  </action>
  <verify>npx convex dev --once (should deploy all 3 new tables)</verify>
  <done>All three tables (dynamicContentInstances, activityLog, shareLinks) deployed with indexes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx convex dev --once` succeeds without errors
- [ ] Schema includes all three new tables
- [ ] All indexes defined correctly
</verification>

<success_criteria>

- All tasks completed
- Schema deployed to Convex
- Tables ready for subsequent plans to use
</success_criteria>

<output>
After completion, create `.planning/phases/20-dynamic-content-system/20-01-SUMMARY.md`
</output>
