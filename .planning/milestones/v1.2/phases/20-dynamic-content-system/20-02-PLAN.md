---
phase: 20-dynamic-content-system
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified: [app/convex/dynamicContent.ts, app/src/components/ProcedureSteps.tsx, app/src/components/ChecklistView.tsx]
autonomous: true
---

<objective>
Build completion tracking system — Convex mutations for starting/completing instances, plus procedure and checklist renderers with interactive step tracking.

Purpose: Enable staff to complete procedures step-by-step with progress tracking, and check off checklist items with persisted state.
Output: Backend API for instance management + two interactive content renderers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-dynamic-content-system/20-RESEARCH.md

@app/convex/schema.ts
@app/convex/documents.ts
@app/src/components/DocumentViewer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dynamicContent.ts with instance mutations</name>
  <files>app/convex/dynamicContent.ts</files>
  <action>
Create new Convex module `app/convex/dynamicContent.ts` with mutations for instance lifecycle:

**startInstance mutation:**
- Args: `documentId: v.id("documents")`
- Validates document exists and has contentType of procedure/checklist/form
- Parses steps from content (use h2 headers as step boundaries for procedures, list items for checklists)
- Creates instance in `dynamicContentInstances` with:
  - sourceDocumentId, sourceType matching document.contentType
  - userId from ctx.auth (null if anonymous)
  - status: "in_progress"
  - completionData: JSON with step states (array of booleans)
  - completedSteps: 0, totalSteps: parsed count
  - startedAt: Date.now()
- Returns instanceId

**completeStep mutation:**
- Args: `instanceId: v.id("dynamicContentInstances"), stepIndex: v.number(), completed: v.boolean()`
- Verifies instance access (owner or session match)
- Updates completionData JSON at stepIndex
- Recalculates completedSteps atomically
- If all steps complete, sets status to "completed" and completedAt
- Returns updated instance

**getInstanceForDocument query:**
- Args: `documentId: v.id("documents")`
- Returns user's active instance (in_progress) for this document, or null
- Used by renderers to show existing progress

**getUserInstances query:**
- Args: `status: v.optional(v.string()), limit: v.optional(v.number())`
- Returns user's instances, optionally filtered by status
- Ordered by startedAt desc

Helper function `parseStepsFromContent(content: string, contentType: string)`:
- For procedure: Extract h2 headers as steps
- For checklist: Extract markdown list items (lines starting with `- [ ]` or `- `)
- Returns array of step titles
  </action>
  <verify>npx convex dev --once (module compiles and deploys)</verify>
  <done>All mutations and queries work, step parsing extracts headers/list items correctly</done>
</task>

<task type="auto">
  <name>Task 2: Create ProcedureSteps component</name>
  <files>app/src/components/ProcedureSteps.tsx</files>
  <action>
Create `ProcedureSteps.tsx` — interactive procedure renderer with step-by-step progress tracking.

**Props:**
```typescript
interface ProcedureStepsProps {
  document: { _id: string; title: string; content: string; contentType?: string };
  instanceId?: string; // Existing instance to continue
}
```

**Behavior:**
1. On mount, check for existing instance via `getInstanceForDocument` query
2. If no instance and user clicks "Start Procedure", call `startInstance` mutation
3. Display procedure content with numbered steps (parsed from h2 headers)
4. Each step has a checkbox — checking calls `completeStep` mutation
5. Show progress bar: "3 of 7 steps complete"
6. When all complete, show "Completed" badge with timestamp

**Wireframe:**
```
+------------------------------------------+
|  [Procedure Title]           [3/7 steps] |
|  ========================================|
|  Progress: [████████░░░░░░░░░░░░░] 43%   |
+------------------------------------------+
|  [x] Step 1: Preparation                 |
|      Step 1 content here...              |
|                                          |
|  [x] Step 2: Setup Equipment             |
|      Step 2 content here...              |
|                                          |
|  [ ] Step 3: Begin Process               |
|      Step 3 content here...              |
+------------------------------------------+
```

**Styling:**
- Use design tokens (--color-ink, --space-*, --font-display)
- Checkbox: styled checkbox matching brand (square, no border-radius)
- Progress bar: bronze fill on cream background
- Completed steps: slightly muted text, checkmark icon
  </action>
  <verify>bun run build (component compiles without errors)</verify>
  <done>ProcedureSteps renders procedure content with interactive checkboxes and progress tracking</done>
</task>

<task type="auto">
  <name>Task 3: Create ChecklistView component</name>
  <files>app/src/components/ChecklistView.tsx</files>
  <action>
Create `ChecklistView.tsx` — interactive checklist with completion tracking.

**Props:**
```typescript
interface ChecklistViewProps {
  document: { _id: string; title: string; content: string; contentType?: string };
  instanceId?: string;
}
```

**Behavior:**
1. Same instance management pattern as ProcedureSteps
2. Parse checklist items from markdown content (list items)
3. Display as simple checklist with checkboxes
4. Persist state via `completeStep` mutation
5. Show completion count: "5 of 12 items checked"

**Wireframe:**
```
+------------------------------------------+
|  [Checklist Title]          [5/12 items] |
+------------------------------------------+
|  [x] Item 1 text here                    |
|  [x] Item 2 text here                    |
|  [ ] Item 3 text here                    |
|  [ ] Item 4 text here                    |
|  ...                                     |
+------------------------------------------+
|  [Reset]                    [Mark All]   |
+------------------------------------------+
```

**Styling:**
- Simpler than procedure (no content per step, just items)
- Clean list with good spacing
- Optional "Reset" button to uncheck all
- Optional "Mark All" for quick completion
  </action>
  <verify>bun run build (component compiles without errors)</verify>
  <done>ChecklistView renders interactive checklist with persistent completion state</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx convex dev --once` deploys dynamicContent.ts
- [ ] `bun run build` succeeds
- [ ] Mutations create/update instances correctly
- [ ] Components render with proper styling
</verification>

<success_criteria>

- All tasks completed
- Instance lifecycle works (start → track steps → complete)
- Both renderers show interactive progress
</success_criteria>

<output>
After completion, create `.planning/phases/20-dynamic-content-system/20-02-SUMMARY.md`
</output>
