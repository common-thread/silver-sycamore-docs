---
phase: 20-dynamic-content-system
plan: 03
type: execute
wave: 2
depends_on: ["20-01"]
files_modified: [app/convex/activity.ts, app/src/components/ActivitySidebar.tsx, app/src/components/ActivityDashboard.tsx]
autonomous: true
---

<objective>
Build activity tracking system — Convex mutations to log activity, queries to retrieve history, and UI components for workspace sidebar and full dashboard views.

Purpose: Give staff visibility into their completion history and incoming form submissions. Activity appears in workspace sidebar (quick view) and dedicated dashboard (full view with filtering).
Output: Activity logging API + two activity display components.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-dynamic-content-system/20-RESEARCH.md

@app/convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create activity.ts with logging and query functions</name>
  <files>app/convex/activity.ts</files>
  <action>
Create new Convex module `app/convex/activity.ts` with activity logging and retrieval.

**logActivity mutation (internal helper):**
- Args: `type, instanceId?, documentId?, formSubmissionId?, title, fromUserId?`
- Inserts into activityLog table with userId from ctx.auth
- Used internally by other modules (dynamicContent, forms) — not exposed to client

**getRecentActivity query:**
- Args: `limit: v.optional(v.number())` (default 10)
- Returns user's recent activity ordered by createdAt desc
- Real-time: Convex auto-updates when activity changes
- Used by ActivitySidebar

**getActivityDashboard query:**
- Args: `{ type?: string, dateFrom?: number, dateTo?: number, limit?: number, cursor?: string }`
- Returns filtered activity with cursor pagination
- Supports filtering by activity type and date range
- Used by ActivityDashboard

**Export helper for other modules:**
```typescript
export async function logActivityInternal(
  ctx: MutationCtx,
  activity: {
    userId: Id<"users">;
    type: ActivityType;
    instanceId?: Id<"dynamicContentInstances">;
    documentId?: Id<"documents">;
    formSubmissionId?: Id<"formSubmissions">;
    title: string;
    fromUserId?: Id<"users">;
  }
) {
  await ctx.db.insert("activityLog", {
    ...activity,
    createdAt: Date.now(),
  });
}
```

This internal helper is called from dynamicContent.ts when procedures/checklists complete, and from forms.ts when forms are submitted.
  </action>
  <verify>npx convex dev --once (module compiles and deploys)</verify>
  <done>Activity logging and queries work, real-time updates functional</done>
</task>

<task type="auto">
  <name>Task 2: Create ActivitySidebar component</name>
  <files>app/src/components/ActivitySidebar.tsx</files>
  <action>
Create `ActivitySidebar.tsx` — compact activity feed for workspace sidebar.

**Props:**
```typescript
interface ActivitySidebarProps {
  limit?: number; // Default 5
}
```

**Behavior:**
1. Query `getRecentActivity` with limit
2. Display compact list of recent activities
3. Each item shows: icon (by type), title, relative time ("2h ago")
4. Click navigates to related document/form
5. "View All" link to /activity dashboard

**Wireframe:**
```
+---------------------------+
|  My Activity              |
+---------------------------+
|  ✓ Completed: Opening...  |
|    2 hours ago            |
|                           |
|  □ Started: Event Setup   |
|    Yesterday              |
|                           |
|  ↓ Received: Contact Form |
|    3 days ago             |
+---------------------------+
|  [View All Activity →]    |
+---------------------------+
```

**Icons by type:**
- procedure_started: □ (empty checkbox)
- procedure_completed: ✓ (checkmark)
- checklist_completed: ✓ (checkmark)
- form_submitted: ↑ (up arrow)
- form_received: ↓ (down arrow)

**Styling:**
- Compact: small text, tight spacing
- Use design tokens
- Hover state for clickable items
  </action>
  <verify>bun run build (component compiles)</verify>
  <done>ActivitySidebar shows recent activity with icons and relative timestamps</done>
</task>

<task type="auto">
  <name>Task 3: Create ActivityDashboard component</name>
  <files>app/src/components/ActivityDashboard.tsx</files>
  <action>
Create `ActivityDashboard.tsx` — full activity view with filtering.

**Props:**
```typescript
interface ActivityDashboardProps {
  // No props needed - gets filters from state
}
```

**Behavior:**
1. Query `getActivityDashboard` with current filters
2. Filter controls: type dropdown, date range (this week/month/all)
3. Display activity in card format with more detail
4. Load more button for pagination
5. Empty state when no activity

**Wireframe:**
```
+------------------------------------------------+
|  Activity History                               |
+------------------------------------------------+
|  Filter: [All Types ▼] [This Month ▼]          |
+------------------------------------------------+
|  +------------------------------------------+  |
|  |  ✓ Completed Procedure                   |  |
|  |  Opening Checklist                       |  |
|  |  January 17, 2026 at 2:30 PM             |  |
|  |  [View Document →]                       |  |
|  +------------------------------------------+  |
|                                                |
|  +------------------------------------------+  |
|  |  ↓ Form Received                         |  |
|  |  Contact Form from John Doe              |  |
|  |  January 16, 2026 at 11:00 AM            |  |
|  |  [View Submission →]                     |  |
|  +------------------------------------------+  |
|                                                |
|  [Load More]                                   |
+------------------------------------------------+
```

**Styling:**
- Use ContentBox for cards
- Filter dropdowns use Select component
- Full timestamps, not relative
- Clear visual hierarchy
  </action>
  <verify>bun run build (component compiles)</verify>
  <done>ActivityDashboard shows filterable activity with pagination</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx convex dev --once` deploys activity.ts
- [ ] `bun run build` succeeds
- [ ] Activity queries return data correctly
- [ ] Both components render with proper styling
</verification>

<success_criteria>

- All tasks completed
- Activity logging works from internal calls
- Sidebar shows compact recent activity
- Dashboard shows full activity with filters
</success_criteria>

<output>
After completion, create `.planning/phases/20-dynamic-content-system/20-03-SUMMARY.md`
</output>
